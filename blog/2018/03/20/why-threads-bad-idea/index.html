<html>
<head><meta name="generator" content="Hexo 3.8.0">
	
	<title>为什么使用多线程在大多数情况下是个坏注意？</title>
	<meta name="keywords" content="fzb.me,冯宗宝,冯宗宝的blog">

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
	   <link href="/blog/css/main.css?v=3" rel="stylesheet" type="text/css">
    
        <script src="/blog/js/util.js"></script>
        <script>
            if(isMobile()) {
                loadjscssfile('../css/mobile.css', 'css');
            } else {
                loadjscssfile('../css/desktop.css', 'css');
            }
        </script> 
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico?v=3">
    
    

</head>

<body>


<h2 class="title">为什么使用多线程在大多数情况下是个坏注意？</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2018年3月20日




 </div>
--->


<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多线程的使用场景"><span class="toc-text">多线程的使用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么多线程很难"><span class="toc-text">为什么多线程很难</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事件驱动编程"><span class="toc-text">事件驱动编程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事件驱动编程被用在哪些场景"><span class="toc-text">事件驱动编程被用在哪些场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事件驱动带来的问题"><span class="toc-text">事件驱动带来的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事件VS多线程"><span class="toc-text">事件VS多线程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#你应该放弃多线程吗"><span class="toc-text">你应该放弃多线程吗</span></a></li></ol>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><hr>
<p>什么是线程？</p>
<ul>
<li>诞生并成长于操作系统这个世界中</li>
<li>在用户级别的工具中慢慢演进</li>
<li>被提议为多种多样的问题的一种解决方案</li>
</ul>
<p>那么，上面说的如此明确了，我们是否在现实工作中成为一个彻头彻尾的“多线程程序员”呢？</p>
<p>多线程带来的问题： 多线程程序很难编写</p>
<p>相对于多线程的一个折中方案： 采用事件驱动的思想</p>
<p>声明：</p>
<ul>
<li>对于大多数的场景，事件要比多线程更好</li>
<li>多线程一般只能用于真正确实需要用到CPU并行的场景</li>
</ul>
<h2 id="多线程的使用场景"><a href="#多线程的使用场景" class="headerlink" title="多线程的使用场景"></a>多线程的使用场景</h2><hr>
<ul>
<li>操作系统： 一个内核线程对应一个用户进程</li>
<li>科学计算： 一个线程可以绑定到一个CPU上执行，有效利用多核，提高性能。（比如大规模非线性方程组运算等等）</li>
<li><p>分布式系统： 大量进程的并发请求（IO复用）</p>
</li>
<li><p>GUI编程： 线程对应用户的Action（按钮点击等）。比如需要一个后台线程长时间做运算，并最终显示结果在GUI上。</p>
</li>
<li><p>多媒体，动画： 类似于GUI</p>
</li>
</ul>
<h2 id="为什么多线程很难"><a href="#为什么多线程很难" class="headerlink" title="为什么多线程很难"></a>为什么多线程很难</h2><hr>
<ul>
<li><p>同步：访问共享数据的时候都要加锁。忘记加锁了？对不起，数据损毁。</p>
</li>
<li><p>死锁： 多线程访问多个锁，锁之间有循环依赖。多个进程互相等待，造成系统挂起</p>
</li>
<li><p>难以Debug： 数据依赖，操作时序依赖</p>
</li>
<li><p>多线程破坏了抽象： 不能设计独立强的模块</p>
</li>
<li><p>回调函数不能与锁一起良好进行工作</p>
</li>
<li><p>很难达到理想性能：锁的粒度控制不好容易造成并发度降低，操作系统的调度和上下文切换机制限制了软件性能（用户态切换到内核态的时间是很昂贵的）</p>
</li>
<li><p>多线程不被良好支持： 操作系统提供的原生线程API不兼容，难以移植。</p>
</li>
</ul>
<h2 id="事件驱动编程"><a href="#事件驱动编程" class="headerlink" title="事件驱动编程"></a>事件驱动编程</h2><hr>
<ul>
<li>单个执行流： 没有CPU并行</li>
<li>可以注册感兴趣的事件（通过回调函数）</li>
<li>Event-loop等待事件，并调用对应的event handler</li>
<li>event handler之间没有优先级（内核线程调度有优先级）</li>
<li>event handler的生命周期很短 （内核线程创建销毁耗时）</li>
</ul>
<h2 id="事件驱动编程被用在哪些场景"><a href="#事件驱动编程被用在哪些场景" class="headerlink" title="事件驱动编程被用在哪些场景"></a>事件驱动编程被用在哪些场景</h2><hr>
<ul>
<li><p>大多数的GUI框架，按钮响应等对应一个Event，一个Event对应一个Event Handler。一个Event Handler可以实现一些行为，打开文件，删除等等</p>
</li>
<li><p>分布式系统。一个handler对应每个输入源（Socket），handler处理请求和回送响应。事件驱动型的IO复用。</p>
</li>
</ul>
<h2 id="事件驱动带来的问题"><a href="#事件驱动带来的问题" class="headerlink" title="事件驱动带来的问题"></a>事件驱动带来的问题</h2><hr>
<ul>
<li><p>handler如果进行长时间的运算，会导致程序长时间无响应（因为是单线程执行流，比如node.js）。对于这种耗时的运算，可以fork一个子进程来处理，子进程通过事件来通知主进程自己的完成情况。</p>
</li>
<li><p>不能跨事件的维护一个local state。（handler必须返回）</p>
</li>
<li><p>单线程执行流不能利用多核，也就是不适用于科学计算软件</p>
</li>
</ul>
<h2 id="事件VS多线程"><a href="#事件VS多线程" class="headerlink" title="事件VS多线程"></a>事件VS多线程</h2><hr>
<ul>
<li><p>事件尽可能避免了并发，多线程相反。事件驱动更好入门，没有数据竞争和死锁。多线程可能对于一个简单场景用起来都更复杂。</p>
</li>
<li><p>事件驱动的程序更好Debug。时序依赖只跟事件有关，没有内部调度。</p>
</li>
<li><p>事件驱动在单核CPU上性能往往比多线程的程序性能更好。</p>
</li>
<li><p>事件驱动的程序比多线程程序更好移植。</p>
</li>
<li><p>多线程程序才能真正利用多核</p>
</li>
</ul>
<h2 id="你应该放弃多线程吗"><a href="#你应该放弃多线程吗" class="headerlink" title="你应该放弃多线程吗"></a>你应该放弃多线程吗</h2><hr>
<ul>
<li>不能，在高性能服务器上必须有效利用多线程，比如数据库软件。</li>
</ul>


<!--<a href="https://alexiachen.github.io/blog/2018/03/20/why-threads-bad-idea/#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = ''; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=&web_id=" language="JavaScript"></script>script>
</div>






</body>
</html>