<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>MathxH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="System Software Engineer">
<meta property="og:type" content="website">
<meta property="og:title" content="MathxH">
<meta property="og:url" content="https://alexiachen.github.io/blog/page/2/index.html">
<meta property="og:site_name" content="MathxH">
<meta property="og:description" content="System Software Engineer">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MathxH">
<meta name="twitter:description" content="System Software Engineer">
  
    <link rel="alternate" href="/blog/atom.xml" title="MathxH" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">MathxH</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blog/" id="subtitle">MathxH</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
          <a class="main-nav-link" href="/blog/about">About</a>
        
          <a class="main-nav-link" href="/blog/resume">Resume</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://alexiachen.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-win32-dump" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/06/03/win32-dump/" class="article-date">
  <time datetime="2018-06-03T04:58:23.000Z" itemprop="datePublished">2018-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/06/03/win32-dump/">windows用户态程序的dump文件生成</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>熟悉Linux的开发人员都知道，在Linux下开发程序，如果程序崩溃了，可以通过配置Core Dump，来让程序崩溃的瞬间产生一个Dump文件，然后通过dump文件来调试程序为什么崩溃。但是windows下就比较麻烦。</p>
<p>windows下配置用户态程序的Dump非常<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb787181\(v=vs.85\" target="_blank" rel="noopener">麻烦</a>.aspx)。</p>
<p>总结后第一种的方式是用一个微软出品的<a href="https://support.microsoft.com/zh-cn/help/241215/how-to-use-the-userdump-exe-tool-to-create-a-dump-file" target="_blank" rel="noopener">官方工具</a>，是一个UserDump.exe的命令行工具。</p>
<p>用法是： 下载下来，安装，解压到特定目录，里面就可以看到userdump.exe这个命令行工具了，把这个命令行工具随着公司的产品软件打包，在产品软件中的main函数中编写如下代码:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">LONG __stdcall</span><br><span class="line">MyUnhandledExceptionFilter(</span><br><span class="line">    EXCEPTION_POINTERS *ExceptionInfo</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Invoke userdump here.</span></span><br><span class="line">    <span class="comment">// The implementation is similar to MyFilterFunction,</span></span><br><span class="line">    <span class="comment">// above.</span></span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>)ExceptionInfo;</span><br><span class="line"></span><br><span class="line">    QString dumperExe = QString(<span class="string">"%1/%2/%3"</span>).arg(qApp-&gt;applicationDirPath()).arg(<span class="string">"dumper"</span>).arg(<span class="string">"userdump.exe"</span>);</span><br><span class="line"></span><br><span class="line">    QString cmdLine = QString(<span class="string">"%1 -k -w %2"</span>).arg(dumperExe).arg(<span class="string">"TRMSMonitor.exe"</span>); <span class="comment">// product.exe</span></span><br><span class="line"></span><br><span class="line">    QProcess* startDump = <span class="keyword">new</span> QProcess;</span><br><span class="line">    startDump-&gt;start(cmdLine);</span><br><span class="line">    startDump-&gt;waitForFinished(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXCEPTION_EXECUTE_HANDLER;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">QApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">    SetUnhandledExceptionFilter(MyUnhandledExceptionFilter);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主程序单例模式</span></span><br><span class="line">    <span class="function">RunGuard <span class="title">guard</span><span class="params">(<span class="string">"TRMS"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!guard.tryToRun()) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// any code here</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a.exec();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码的意思是，在程序崩溃的瞬间，未处理异常的时刻，调用userdump命令行来生成程序自身的Dump文件。</p>
<p>方法二，修改系统注册表的方式来让系统自动产生Dump，最推荐这样的方式，这种方式最准确。用法<a href="https://www.cnblogs.com/hushaojun/p/6388153.html" target="_blank" rel="noopener">戳这里</a>。</p>
<p>如果WinDbg下载了符号表，那么直接可以把产生crash的源码崩溃地点显示出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Microsoft (R) Windows Debugger Version 6.12.0002.633 X86 Copyright (c) Microsoft Corporation. All rights reserved. Loading Dump File [C:\crashdumps\mid.exe.2324.dmp] User Mini Dump File with Full Memory: Only application data is available WARNING: Minidump contains unknown stream type 0x15 WARNING: Minidump contains unknown stream type 0x16 Symbol search path is: srv*c:\symbols*http://msdl.microsoft.com/download/symbols Executable search path is: Windows 7 Version 16299 MP (4 procs) Free x64 Product: WinNt, suite: SingleUserTS Machine Name: Debug session time: Fri May 4 10:57:03.000 2018 (UTC + 8:00)</span><br><span class="line">System Uptime: 0 days 23:20:34.747</span><br><span class="line">Process Uptime: 0 days 0:00:03.000</span><br><span class="line">........................................</span><br><span class="line">This dump file has an exception of interest stored in it.</span><br><span class="line">The stored exception information can be accessed via .ecxr.</span><br><span class="line">(914.35c4): Access violation - code c0000005 (first/second chance not available)</span><br><span class="line">ntdll!ZwWaitForMultipleObjects+0x14:</span><br><span class="line">00007ffe`5c5b0e14 c3 ret</span><br><span class="line">0:000&gt; !analyze -v</span><br><span class="line">*******************************************************************************</span><br><span class="line">* *</span><br><span class="line">* Exception Analysis *</span><br><span class="line">* *</span><br><span class="line">*******************************************************************************</span><br><span class="line"> </span><br><span class="line">Failed calling InternetOpenUrl, GLE=12029</span><br><span class="line"> </span><br><span class="line">FAULTING_IP: </span><br><span class="line">mid!CJASE2000App::InitInstance+3c [d:\furen-work\furen-projects\tuxedo-projects\zjj\mid\jase2000.cpp @ 223]</span><br><span class="line">00007ff6`ced7aa9c 45892424 mov dword ptr [r12],r12d</span><br><span class="line"> </span><br><span class="line">EXCEPTION_RECORD: ffffffffffffffff -- (.exr 0xffffffffffffffff)</span><br><span class="line">ExceptionAddress: 00007ff6ced7aa9c (mid!CJASE2000App::InitInstance+0x000000000000003c)</span><br><span class="line"> ExceptionCode: c0000005 (Access violation)</span><br><span class="line">ExceptionFlags: 00000000</span><br><span class="line">NumberParameters: 2</span><br><span class="line"> Parameter[0]: 0000000000000001</span><br><span class="line"> Parameter[1]: 0000000000000000</span><br><span class="line">Attempt to write to address 0000000000000000</span><br><span class="line"> </span><br><span class="line">DEFAULT_BUCKET_ID: NULL_POINTER_WRITE</span><br><span class="line"> </span><br><span class="line">PROCESS_NAME: mid.exe</span><br><span class="line"> </span><br><span class="line">ERROR_CODE: (NTSTATUS) 0xc0000005 - 0x%p</span><br><span class="line"> </span><br><span class="line">EXCEPTION_CODE: (NTSTATUS) 0xc0000005 - 0x%p</span><br><span class="line"> </span><br><span class="line">EXCEPTION_PARAMETER1: 0000000000000001</span><br><span class="line"> </span><br><span class="line">EXCEPTION_PARAMETER2: 0000000000000000</span><br><span class="line"> </span><br><span class="line">WRITE_ADDRESS: 0000000000000000</span><br><span class="line">FOLLOWUP_IP: </span><br><span class="line">mid!CJASE2000App::InitInstance+3c [d:\furen-work\furen-projects\tuxedo-projects\zjj\mid\jase2000.cpp @ 223]</span><br><span class="line">00007ff6`ced7aa9c 45892424 mov dword ptr [r12],r12d</span><br><span class="line"> </span><br><span class="line">MOD_LIST: &lt;ANALYSIS/&gt;  </span><br><span class="line">NTGLOBALFLAG: 0</span><br><span class="line"> </span><br><span class="line">APPLICATION_VERIFIER_FLAGS: 0</span><br><span class="line"> </span><br><span class="line">FAULTING_THREAD: 00000000000035c4</span><br><span class="line"> </span><br><span class="line">PRIMARY_PROBLEM_CLASS: NULL_POINTER_WRITE</span><br><span class="line"> </span><br><span class="line">BUGCHECK_STR: APPLICATION_FAULT_NULL_POINTER_WRITE</span><br><span class="line"></span><br><span class="line">LAST_CONTROL_TRANSFER: from 000000005e44ccae to 00007ff6ced7aa9c</span><br><span class="line"> </span><br><span class="line">STACK_TEXT: </span><br><span class="line">00000000`00cff3a0 00000000`5e44ccae : 00000000`00000001 00000000`00000001 00007ff6`ced30000 00000000`00000000 : mid!CJASE2000App::InitInstance+0x3c [d:\furen-work\furen-projects\tuxedo-projects\zjj\mid\jase2000.cpp @ 223]</span><br><span class="line">00000000`00cff710 00007ff6`ceda05e3 : 00000000`02eb4383 00000000`00000000 00000000`00000000 00000000`00000000 : mfc100!AfxWinMain+0x76</span><br><span class="line">00000000`00cff750 00007ffe`5a8d1fe4 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : mid!__tmainCRTStartup+0x15f [f:\dd\vctools\crt_bld\self_64_amd64\crt\src\crtexe.c @ 547] 00000000`00cff800 00007ffe`5c57f061 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : kernel32!BaseThreadInitThunk+0x14</span><br><span class="line">00000000`00cff830 00000000`00000000 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : ntdll!RtlUserThreadStart+0x21</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">FAULTING_SOURCE_CODE: </span><br><span class="line"> 219: // registerExceptionHandler(); </span><br><span class="line">220: </span><br><span class="line"> 221: int *pSS = NULL;</span><br><span class="line"> 222: &gt; 223: *pSS = 0;</span><br><span class="line"> 224: </span><br><span class="line"> 225: m_hMutex = CreateMutex( </span><br><span class="line">226: NULL, // no security descriptor</span><br><span class="line"> 227: FALSE, // mutex not owned</span><br><span class="line"> 228: &quot;KD20_Transaction&quot;); // object name</span><br><span class="line"> </span><br><span class="line">SYMBOL_STACK_INDEX: 0</span><br><span class="line"> </span><br><span class="line">SYMBOL_NAME: mid!CJASE2000App::InitInstance+3c</span><br><span class="line"> </span><br><span class="line">FOLLOWUP_NAME: MachineOwner</span><br><span class="line"> MODULE_NAME: mid</span><br><span class="line"> </span><br><span class="line">IMAGE_NAME: mid.exe</span><br><span class="line"> </span><br><span class="line">DEBUG_FLR_IMAGE_TIMESTAMP: 5aebcbd4</span><br><span class="line"> </span><br><span class="line">STACK_COMMAND: dt ntdll!LdrpLastDllInitializer BaseDllName ; dt ntdll!LdrpFailureData ; ~0s; .ecxr ; kb</span><br><span class="line"> </span><br><span class="line">FAILURE_BUCKET_ID: NULL_POINTER_WRITE_c0000005_mid.exe!CJASE2000App::InitInstance</span><br><span class="line"> </span><br><span class="line">BUCKET_ID: X64_APPLICATION_FAULT_NULL_POINTER_WRITE_mid!CJASE2000App::InitInstance+3c</span><br><span class="line"> </span><br><span class="line">WATSON_STAGEONE_URL: http://watson.microsoft.com/StageOne/mid_exe/2_0_0_0/5aebcbd4/mid_exe/2_0_0_0/5aebcbd4/c0000005/0004aa9c.htm?Retriage=1</span><br><span class="line"> </span><br><span class="line">Followup: MachineOwner</span><br></pre></td></tr></table></figure>
<p>EOF</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexiachen.github.io/blog/2018/06/03/win32-dump/" data-id="cjtcsryez002ir8qffdb81o83" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Win32/">Win32</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/操作系统/">操作系统</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-multi-cores-programming" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/04/13/multi-cores-programming/" class="article-date">
  <time datetime="2018-04-13T04:01:23.000Z" itemprop="datePublished">2018-04-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/04/13/multi-cores-programming/">多核编程的相关理论及实践</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p><em>这篇文章主要是看brpc的文档的心得体会吧，brpc算是国内高性能RPC框架中文档写得最好，最有诚意的作品了。就算不看它的源码，看它的文档也能收获很大，干货满满，在这过程中也解答了我以前的困惑。</em></p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><hr>
<p>在开篇之前，我想说点文体风格，由于阅读<a href="https://github.com/brpc/brpc" target="_blank" rel="noopener">brpc</a>的文档给了我巨大的收获，所以文体的风格会以问答的方式展开。顺便给出原理解释，还有感受下<a href="https://www.linkedin.com/in/gejun" target="_blank" rel="noopener">戈君大神</a>在文档中浸淫多年的软件基础设施工程实践心得体会。我文字理解驾驭不了的地方会选择性地摘抄文档内容。</p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><hr>
<h3 id="1-如何针对写多读少的场景设计一个多线程计数器？"><a href="#1-如何针对写多读少的场景设计一个多线程计数器？" class="headerlink" title="1. 如何针对写多读少的场景设计一个多线程计数器？"></a>1. 如何针对写多读少的场景设计一个多线程计数器？</h3><p>大部分RPC框架，或者其他中间件或多或少都需要有这样的需求，因为这些中间件基本都是主打高性能的，高效利用多核多线程。既然是高性能，都需要为它设计计数器，目的是为了方<br>便统计各种服务的调用次数，还有其他性能参数（QPS,平均延时），以达到监控服务，调优服务的最终目的。<br>本着最直观的理解，写下了如下最简单的计数器代码:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">int</span> global_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//高并发下，多线程调用这个服务，显而易见需要加锁解锁，构成一个临界区</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">service</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    lock();</span><br><span class="line">    global_count++;</span><br><span class="line">    unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码是正确的，global_count在多线程调用的累加下不会出错。但是由于多线程高频率修改global_count，性能可能没你想象的好，因为造成了大量的<a href="https://en.wikipedia.org/wiki/Race_condition" target="_blank" rel="noopener">Race Condition</a>。这时候锁的性能造成了瓶颈。你不得不想方设法的绕开锁的限制。</p>
<p>这里有一点值得注意，C++提供的std::mutex在大部分不压榨性能的场景足够用了，造成std::mutex性能低下的两点，一个是std::mutex的粒度过大，也就是临界区过大限制了并发度。另一个就是频繁的访问导致锁争用，上下文切换非常频繁。</p>
<p>那么如何解决计数器遇到的这个问题呢？ 其实最直观的就是避免共享，避免锁争用。用<a href="https://en.wikipedia.org/wiki/Thread-local_storage" target="_blank" rel="noopener">thread local</a>技术来避免减少大量的Cache Bouncing，该技术原理是每个线程修改（写）global_count只维持线程自己的一个变量累加的副本。等到有线程读global_count的时候，就把各个线程的变量副本的结果合并起来，这个速度就会显得慢了，不过因为是写多读少的场景，所以没有问题。</p>
<h3 id="2-Cache-Bouncing是为何物？"><a href="#2-Cache-Bouncing是为何物？" class="headerlink" title="2. Cache Bouncing是为何物？"></a>2. Cache Bouncing是为何物？</h3><p>为了以较低的成本大幅提高性能，现代CPU都有cache。cpu cache已经发展到了三级缓存结构，基本上现在买的个人电脑都是L3结构。其中L1和L2 cache为每个核独有，L3则所有核共享。为了保证所有的核看到正确的内存数据，一个核在写入自己的L1 cache后，CPU会执行<a href="https://en.wikipedia.org/wiki/Cache_coherence" target="_blank" rel="noopener">Cache一致性算法</a>把对应的Cache Line(一般是64字节)同步到其他核的Cache中。这个过程并不很快，是微秒级的，相比之下写入L1 cache只需要若干纳秒。当很多线程在频繁修改某个共享字段变量时，这个字段所在的Cache Line被不停地同步到不同的核上，就像在核间弹来弹去，这个现象就叫做Cache Bouncing。由于实现cache一致性往往有硬件锁，Cache Bouncing是一种隐式的的全局竞争。</p>
<p>当然Cache一致性算法有多种，其中一种听到的最多的叫<a href="https://en.wikipedia.org/wiki/MESI_protocol" target="_blank" rel="noopener">MESI协议</a>。</p>
<h3 id="3-CAS原子指令为什么会这么难？"><a href="#3-CAS原子指令为什么会这么难？" class="headerlink" title="3. CAS原子指令为什么会这么难？"></a>3. CAS原子指令为什么会这么难？</h3><p>多核多线程编程常用锁避免多个线程在修改同一个数据时产生race condition。当锁成为性能瓶颈时，我们又总想试着绕开它，而不可避免地接触了原子指令（用于实现Lock-Free和Wait-Free等数据结构和算法）。但在实践中，用CAS原子指令写出正确的代码是一件非常困难的事，各种概念接踵而来，琢磨不透的race condition、<a href="https://en.wikipedia.org/wiki/ABA_problem" target="_blank" rel="noopener">ABA problem</a>、<a href="https://en.wikipedia.org/wiki/Memory_barrier" target="_blank" rel="noopener">memory barrier</a>很烧脑。（Memory Barrier又叫内存栅栏，内存屏障）。</p>
<p>顾名思义，原子指令是对软件不可再分的指令，比如x.fetch_add(n)指原子地给x加上n，这个指令对软件要么没做，要么完成，不会观察到中间状态。常见的原子指令有：</p>
<table>
<thead>
<tr>
<th>原子指令 (x均为std::atomic<int>)</int></th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>x.load()</td>
<td>返回x的值。</td>
</tr>
<tr>
<td>x.store(n)</td>
<td>把x设为n，什么都不返回。</td>
</tr>
<tr>
<td>x.exchange(n)</td>
<td>把x设为n，返回设定之前的值。</td>
</tr>
<tr>
<td>x.compare_exchange_strong(expected_ref, desired)</td>
<td>若x等于expected_ref，则设为desired，返回成功；否则把最新值写入expected_ref，返回失败。</td>
</tr>
<tr>
<td>x.compare_exchange_weak(expected_ref, desired)</td>
<td>相比compare_exchange_strong可能有<a href="http://en.wikipedia.org/wiki/Spurious_wakeup" target="_blank" rel="noopener">spurious wakeup</a>。</td>
</tr>
<tr>
<td>x.fetch_add(n), x.fetch_sub(n)</td>
<td>原子地做x += n, x-= n，返回修改之前的值。</td>
</tr>
</tbody>
</table>
<p>你已经可以不用显式加锁用这些指令做原子计数，比如多个线程同时累加一个原子变量，以统计这些线程对一些资源的操作次数。但是，这可能会有两个问题：</p>
<ul>
<li>这个操作没有你想象地快。</li>
<li>如果你尝试通过看似简单的原子操作控制对一些资源的访问，你的程序有很大几率会crash。</li>
</ul>
<h3 id="4-什么情况下多核之间的Cache-Line会频繁同步导致Cache-Bouncing？"><a href="#4-什么情况下多核之间的Cache-Line会频繁同步导致Cache-Bouncing？" class="headerlink" title="4. 什么情况下多核之间的Cache Line会频繁同步导致Cache Bouncing？"></a>4. 什么情况下多核之间的Cache Line会频繁同步导致Cache Bouncing？</h3><p>一个核心写入自己的L1 cache是极快的(4 cycles, ~2ns)，但当另一个核心读或写同一处内存时，它得确认看到其他核心中对应的cache line。对于软件来说，这个过程是原子的，不能在中间穿插其他代码，只能等待CPU完成一致性同步，这个复杂的硬件算法使得原子操作会变得很慢，竞争激烈时fetch_add会耗费数百纳秒左右。访问被多个线程频繁共享的内存往往是比较慢的。比如像一些场景临界区看着很小，但保护它的spin lock性能不佳，因为spin lock使用的exchange, fetch_add等指令必须等待最新的cache line，看上去只有几条指令，花费若干微秒并不奇怪。</p>
<p>要提高性能，就要避免让CPU频繁同步cache line。这不单和原子指令本身的性能有关，还会影响到程序的整体性能。最有效的解决方法很直白：<strong>尽量避免共享</strong>。（比如用之前提到过的Thread Local）。</p>
<p>一个相关的编程陷阱是<a href="https://en.wikipedia.org/wiki/False_sharing" target="_blank" rel="noopener">False Sharing</a>：对那些不怎么被修改甚至只读变量的访问，由于同一个cache line中的其他变量被频繁修改，而不得不经常等待cache line同步而显著变慢了(也就是被别的变量拉低的性能)。多线程中的变量尽量按访问规律排列，频繁被其他线程修改的变量要放在独立的Cache Line中。要让一个变量或结构体按Cache Line对齐。</p>
<h3 id="5-基于CAS原语的原子指令编写的Lock-Free和Wait-Free数据结构和算法性能一定更高吗？"><a href="#5-基于CAS原语的原子指令编写的Lock-Free和Wait-Free数据结构和算法性能一定更高吗？" class="headerlink" title="5. 基于CAS原语的原子指令编写的Lock-Free和Wait-Free数据结构和算法性能一定更高吗？"></a>5. 基于CAS原语的原子指令编写的Lock-Free和Wait-Free数据结构和算法性能一定更高吗？</h3><p>诚然，原子指令基于CAS原语的控制并发的粒度会更小，但是由此带来了更大的复杂性。它能为服务赋予两个重要的概念<a href="https://en.wikipedia.org/wiki/Non-blocking_algorithm#Lock-freedom" target="_blank" rel="noopener">Lock-Free</a>和<a href="https://en.wikipedia.org/wiki/Non-blocking_algorithm#Wait-freedom" target="_blank" rel="noopener">Wait-Free</a>。</p>
<p>当然前者的意思不言自明了，就是无锁编程（算法），后者是无等待编程（算法）。有的人说，那好了，采用Lock-Free的算法，不用加锁了，显然更快了。Wait-Free那更加快了，都不用等待了。当然理论上是这么一回事，但是工程实践上又是一回事。无锁编程采用底层的CAS原语其实上的是硬件粒度的锁，理论上是更加快，因为一些实时系统的关键部分和一些关键的数据结构为了压榨性能，确实是用Lock-Free的算法和Wait-Free算法编写的。但是，值得注意的事情是：</p>
<ul>
<li><p>lock-free和wait-free必须处理更多更复杂的race condition和ABA problem，完成相同目的的代码比用锁更复杂。代码越多，反而比用小粒度的std::mutex耗时长。</p>
</li>
<li><p>使用mutex的算法变相带“后退”效果。后退(backoff)指出现竞争时尝试另一个途径以临时避免竞争，mutex出现竞争时会使调用者睡眠，使拿到锁的那个线程可以很快地独占完成一系列流程，总体吞吐可能反而高了。</p>
</li>
</ul>
<p>mutex导致低性能往往是因为临界区过大（限制了并发度），或竞争过于激烈（上下文切换开销变得突出）。lock-free/wait-free算法的价值在于其保证了一个或所有线程始终在做有用的事，而不是绝对的高性能。但在一种情况下lock-free和wait-free算法的性能多半更高：就是算法本身可以用少量的CAS原子指令实现。实现锁也是要用原子指令的，当算法本身用一两条指令就能完成的时候，相比额外用锁肯定是更快了。</p>
<p>当然，大部分场景几乎不要用Lock-Free和Wait-Free的算法，一个是因为不需要那么极尽变态地压榨性能。另一个是这两种算法其实很复杂，即使写出来了，从形式化的手段也难以证明算法的正确性。对于越复杂的数据结构越是如此。比如Lock-Free的数据结构目前在boost C++中常见的有Queue, Ring Buffer，Stack这些简单的数据结构。但是如果你搜网络上的论文，就很难见到有Lock-Free的树型数据结构。其一是太复杂了，即使实现并证明正确，但是实测性能可能也没加锁的树形数据结构高。如果这样就舍本逐末了。</p>
<h3 id="6-协程是什么？它为什么不能利用多核？"><a href="#6-协程是什么？它为什么不能利用多核？" class="headerlink" title="6.协程是什么？它为什么不能利用多核？"></a>6.协程是什么？它为什么不能利用多核？</h3><p>协程是一种用户态的线程，由用户态的调度器来调度，因为其非常轻量，可以用来部分代替线程从而实现所谓的高并发（看场景），而且由于协程不对应内核中的线程概念，所以用户可以一瞬间创建出成千上万个协程，而不消耗太多性能，它们之前切换可以非常快（100ns-200ns），受缓存一致性的影响很小。但是呢，平常我们所说的协程并不能利用CPU多核，因为是它相当于是N：1的线程库，就是N个协程只跑在一个内核线程上，一个内核线程只会在一个核上运行。</p>
<p>还有一个缺点就是，因为协程无法高效利用多核，代码必须非阻塞，否则所有协程都会被block住，对开发者要求比较苛刻。协程的这种特点使其非常适合写运行时间基本能确定的IO服务器，比如http server，在一些精心调试的场景中，可以达到非常高的吞吐量（实时大流量）。协程的这个特点与Event Loop的单线程异步是类似的，一个callback函数如果需要等待比较长的时间，那么整个Event Loop就被block住了，其他事件得不到及时响应。</p>
<p>所以可以看到了，Node.js之类的适配上协程确实可以达到高并发，高吞吐，这句话本身没问题。但是这是有场景的，Node.js适合处理IO数据密集型实时应用系统，比如Web消息实时推送（知乎的问答提示），Web可视化数据实时展示。Node非常适合如下情况：在响应客户端之前，你预计可能有很高的流量，但所需的服务器端逻辑和处理不一定很多（服务端不能有复杂计算，复杂业务逻辑，复杂事务处理）。</p>
<p>当然有懂一点的人可能会说，可以开启多个Node.js进程（Cluster模块）来以多个内核线程达到利用多核的目的，当然至于这样是不是很方便，很高效就是另一个话题了。但是据我所知，主流大型互联网公司基础框架想高效的利用多核都不会选择这种方案。</p>
<h3 id="7-Go语言中的GoRoutine是协程吗？为什么它却能利用多核？"><a href="#7-Go语言中的GoRoutine是协程吗？为什么它却能利用多核？" class="headerlink" title="7. Go语言中的GoRoutine是协程吗？为什么它却能利用多核？"></a>7. Go语言中的GoRoutine是协程吗？为什么它却能利用多核？</h3><p>不是，因为GoRoutine是可以利用多核的，它实质上就是个M:N的线程库（一般M会远大于N），M个GoRoutine对应N个内核线程（当然，这个特性是以语言内建特性的方式暴露出来的，而不是标准库的形式，所以写起来会更自然些）。一个RoRoutine因复杂的计算或者同步阻塞IO等待而block住也不会影响其他GoRoutine。</p>
<p>Goroutine调度器的实现由一种关键的技术：<a href="https://en.wikipedia.org/wiki/Work_stealing" target="_blank" rel="noopener">Work-Stealing调度算法</a>。这一种算法的目的是想让GoRoutine更快地被调度到更多的CPU核心上。</p>
<h3 id="8-单线程Reactor和多线程Reactor模型有什么不同？"><a href="#8-单线程Reactor和多线程Reactor模型有什么不同？" class="headerlink" title="8. 单线程Reactor和多线程Reactor模型有什么不同？"></a>8. 单线程Reactor和多线程Reactor模型有什么不同？</h3><p>以libevent, libev等event-loop库为典型。这个模型一般由一个event dispatcher等待各类事件，待事件发生后原地调用对应的event handler，全部调用完后等待更多事件，故为”loop”。这个模型的实质是把多段逻辑按事件触发顺序交织在一个系统线程中。一个event-loop只能使用一个核，故此类程序要么是IO-bound，要么是每个handler有确定的较短的运行时间（比如http server)，否则一个耗时漫长的回调就会卡住整个程序，产生高延时。在实践中这类程序不适合多开发者参与，一个人写了阻塞代码可能就会拖慢其他代码的响应。由于event handler不会同时运行，不太会产生复杂的race condition，一般不需要加锁。此类程序主要靠部署更多进程增加扩展性。Redis就是这么干的。</p>
<p>以boost::asio为典型。一般由一个或多个线程分别运行event dispatcher，待事件发生后把event handler交给一个worker线程执行。 这个模型是单线程reactor的自然扩展，叫多线程Reactor，可以利用多核。由于共用地址空间使得线程间交互变得廉价，worker thread间一般会更及时地均衡负载，而多进程一般依赖更前端的服务（Nginx）来分割流量，一个设计良好的多线程reactor程序往往能比同一台机器上的多个单线程reactor进程更均匀地使用不同核心。不过由于cache一致性的限制，多线程reactor并不能获得线性于核心数的性能，在特定的场景中，粗糙的多线程reactor实现跑在24核上甚至没有精致的单线程reactor实现跑在1个核上快。由于多线程reactor包含多个worker线程，单个event handler阻塞未必会延缓其他handler，所以event handler未必得非阻塞，除非所有的worker线程都被阻塞才会影响到整体进展。事实上，大部分RPC框架都使用了这个模型，且回调中常有阻塞部分，比如同步等待访问下游的RPC返回。</p>
<h3 id="9-N：1线程库和M-N线程库又有什么区别？"><a href="#9-N：1线程库和M-N线程库又有什么区别？" class="headerlink" title="9. N：1线程库和M:N线程库又有什么区别？"></a>9. N：1线程库和M:N线程库又有什么区别？</h3><p>之前提到过，平常所说的协程（Coroutine）相当于是一个N：1的线程库。但是这么说并不代表N：1的线程库就是协程，它有另外的名字叫<a href="https://en.wikipedia.org/wiki/Fiber_\(computer_science\" target="_blank" rel="noopener">纤程（Fiber）</a>)。以GNU Pth, StateThreads等为典型，一般是把N个用户线程映射入一个系统内核线程。同时只运行一个用户线程，调用阻塞函数时才会切换至其他用户线程（有调度器，所以跟Event Loop这点细节上又不大一样）。N:1线程库与单线程reactor在能力上是等价的，但事件回调被替换为了上下文(栈,寄存器,signals)，运行回调变成了跳转至上下文。和event loop库一样，单个N:1线程库无法充分发挥多核性能，只适合一些特定的程序。只有一个系统线程对CPU cache较为友好，加上舍弃对signal mask的支持的话，用户线程间的上下文切换可以很快(100~200ns)。N:1线程库的性能一般和event loop库差不多，扩展性也主要靠多进程。</p>
<p>M:N线程库也只是一种实现思想思路，Goroutine就是这样的实现。即把M个用户线程映射入N个系统内核线程。M:N线程库可以决定一段代码何时开始在哪运行，并何时结束，相比多线程reactor在调度上具备更多的灵活度。但实现全功能的M:N线程库是困难的，它一直是个活跃的研究话题。我们这里说的M:N线程库特别针对编写网络服务，在这一前提下一些需求可以简化，比如没有时间片抢占，没有(完备的)优先级等。M:N线程库可以在用户态也可以在内核中实现，用户态的实现以新语言为主，比如GHC threads和goroutine，这些语言可以围绕线程库设计全新的关键字并拦截所有相关的API。而在现有语言中的实现往往得修改内核，比如Windows UMS和google SwicthTo(虽然是1:1，但基于它可以实现M:N的效果)。相比N:1线程库，M:N线程库在使用上更类似于系统内核线程，需要用锁或消息传递（消息总线，Actor模型，Vert.x，Akka库等代表）保证代码的线程安全。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexiachen.github.io/blog/2018/04/13/multi-cores-programming/" data-id="cjtcsryhi008nr8qf1v06s7tx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/多核编程/">多核编程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/多线程编程/">多线程编程</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-home-network-design" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/04/01/home-network-design/" class="article-date">
  <time datetime="2018-04-01T09:16:53.000Z" itemprop="datePublished">2018-04-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/04/01/home-network-design/">家里面的网络布局方案</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p><em>最近家里搞装修也是累，家里2层楼，至少得3个月。所以对于家庭里面的网络规划不能太忽视。</em></p>
</blockquote>
<h2 id="网络拓扑布局"><a href="#网络拓扑布局" class="headerlink" title="网络拓扑布局"></a>网络拓扑布局</h2><hr>
<p>大概就如下了。</p>
<p><img src="http://wx1.sinaimg.cn/large/a1ac93f3gy1fq0pypcuzoj20ip0b8413.jpg" alt=""></p>
<p>入户光纤的第一台设备是光猫。接下来是路由器，再接下来是千兆交换机（可能是24口）</p>
<p>打算暂时只是把网线布局弄好，设备我以后自己可以慢慢买，所以目的是只用把网线接口布局弄好，网线接口预留好就可以了。还是选择用AP/AC的方案来做无线扩展覆盖。</p>
<p>最重要的要来了，因为以后想搭建家庭私有云，所以有个服务器机房（用夹层储物间）。这里是服务器等交换机设备的集中点，所以这个房间里网线接口和供电插座要多一点。根据文档附带平面图的红色长方形标记出来的网线接口来调整储物间网络中心的的网线接口数量。</p>
<p>因为家庭组<font color="red">千兆网络</font>，所以用<font color="red">超六</font>类网线（当然水晶头也是六类）。</p>
<h2 id="网线接口平面标记图"><a href="#网线接口平面标记图" class="headerlink" title="网线接口平面标记图"></a>网线接口平面标记图</h2><hr>
<p><img src="http://wx3.sinaimg.cn/large/a1ac93f3gy1fq0pyobt5ij20nd0ms0w8.jpg" alt=""></p>
<p><img src="http://wx3.sinaimg.cn/large/a1ac93f3gy1fq0pync2coj20ks0mk77k.jpg" alt=""></p>
<p>以上平面图画四方形的就是网线预留的接口。<br>负一层的储物间用来做服务器机房。到时候会有机架式路由，交换机，还有电源接口。入户的光猫在2楼的书房的弱电箱中，然后网线接到负1楼的储物间连接路由器。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><hr>
<p><a href="https://www.zhihu.com/question/20479299 " target="_blank" rel="noopener">https://www.zhihu.com/question/20479299</a></p>
<p><a href="http://service.tp-link.com.cn/detail_article_458.html" target="_blank" rel="noopener">http://service.tp-link.com.cn/detail_article_458.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexiachen.github.io/blog/2018/04/01/home-network-design/" data-id="cjtcsrydx000ur8qf8ancxvjx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/装修/">装修</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/计算机网络/">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-why-threads-bad-idea" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/03/20/why-threads-bad-idea/" class="article-date">
  <time datetime="2018-03-20T06:00:00.000Z" itemprop="datePublished">2018-03-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/03/20/why-threads-bad-idea/">为什么使用多线程在大多数情况下是个坏注意？</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><hr>
<p>什么是线程？</p>
<ul>
<li>诞生并成长于操作系统这个世界中</li>
<li>在用户级别的工具中慢慢演进</li>
<li>被提议为多种多样的问题的一种解决方案</li>
</ul>
<p>那么，上面说的如此明确了，我们是否在现实工作中成为一个彻头彻尾的“多线程程序员”呢？</p>
<p>多线程带来的问题： 多线程程序很难编写</p>
<p>相对于多线程的一个折中方案： 采用事件驱动的思想</p>
<p>声明：</p>
<ul>
<li>对于大多数的场景，事件要比多线程更好</li>
<li>多线程一般只能用于真正确实需要用到CPU并行的场景</li>
</ul>
<h2 id="多线程的使用场景"><a href="#多线程的使用场景" class="headerlink" title="多线程的使用场景"></a>多线程的使用场景</h2><hr>
<ul>
<li>操作系统： 一个内核线程对应一个用户进程</li>
<li>科学计算： 一个线程可以绑定到一个CPU上执行，有效利用多核，提高性能。（比如大规模非线性方程组运算等等）</li>
<li><p>分布式系统： 大量进程的并发请求（IO复用）</p>
</li>
<li><p>GUI编程： 线程对应用户的Action（按钮点击等）。比如需要一个后台线程长时间做运算，并最终显示结果在GUI上。</p>
</li>
<li><p>多媒体，动画： 类似于GUI</p>
</li>
</ul>
<h2 id="为什么多线程很难"><a href="#为什么多线程很难" class="headerlink" title="为什么多线程很难"></a>为什么多线程很难</h2><hr>
<ul>
<li><p>同步：访问共享数据的时候都要加锁。忘记加锁了？对不起，数据损毁。</p>
</li>
<li><p>死锁： 多线程访问多个锁，锁之间有循环依赖。多个进程互相等待，造成系统挂起</p>
</li>
<li><p>难以Debug： 数据依赖，操作时序依赖</p>
</li>
<li><p>多线程破坏了抽象： 不能设计独立强的模块</p>
</li>
<li><p>回调函数不能与锁一起良好进行工作</p>
</li>
<li><p>很难达到理想性能：锁的粒度控制不好容易造成并发度降低，操作系统的调度和上下文切换机制限制了软件性能（用户态切换到内核态的时间是很昂贵的）</p>
</li>
<li><p>多线程不被良好支持： 操作系统提供的原生线程API不兼容，难以移植。</p>
</li>
</ul>
<h2 id="事件驱动编程"><a href="#事件驱动编程" class="headerlink" title="事件驱动编程"></a>事件驱动编程</h2><hr>
<ul>
<li>单个执行流： 没有CPU并行</li>
<li>可以注册感兴趣的事件（通过回调函数）</li>
<li>Event-loop等待事件，并调用对应的event handler</li>
<li>event handler之间没有优先级（内核线程调度有优先级）</li>
<li>event handler的生命周期很短 （内核线程创建销毁耗时）</li>
</ul>
<h2 id="事件驱动编程被用在哪些场景"><a href="#事件驱动编程被用在哪些场景" class="headerlink" title="事件驱动编程被用在哪些场景"></a>事件驱动编程被用在哪些场景</h2><hr>
<ul>
<li><p>大多数的GUI框架，按钮响应等对应一个Event，一个Event对应一个Event Handler。一个Event Handler可以实现一些行为，打开文件，删除等等</p>
</li>
<li><p>分布式系统。一个handler对应每个输入源（Socket），handler处理请求和回送响应。事件驱动型的IO复用。</p>
</li>
</ul>
<h2 id="事件驱动带来的问题"><a href="#事件驱动带来的问题" class="headerlink" title="事件驱动带来的问题"></a>事件驱动带来的问题</h2><hr>
<ul>
<li><p>handler如果进行长时间的运算，会导致程序长时间无响应（因为是单线程执行流，比如node.js）。对于这种耗时的运算，可以fork一个子进程来处理，子进程通过事件来通知主进程自己的完成情况。</p>
</li>
<li><p>不能跨事件的维护一个local state。（handler必须返回）</p>
</li>
<li><p>单线程执行流不能利用多核，也就是不适用于科学计算软件</p>
</li>
</ul>
<h2 id="事件VS多线程"><a href="#事件VS多线程" class="headerlink" title="事件VS多线程"></a>事件VS多线程</h2><hr>
<ul>
<li><p>事件尽可能避免了并发，多线程相反。事件驱动更好入门，没有数据竞争和死锁。多线程可能对于一个简单场景用起来都更复杂。</p>
</li>
<li><p>事件驱动的程序更好Debug。时序依赖只跟事件有关，没有内部调度。</p>
</li>
<li><p>事件驱动在单核CPU上性能往往比多线程的程序性能更好。</p>
</li>
<li><p>事件驱动的程序比多线程程序更好移植。</p>
</li>
<li><p>多线程程序才能真正利用多核</p>
</li>
</ul>
<h2 id="你应该放弃多线程吗"><a href="#你应该放弃多线程吗" class="headerlink" title="你应该放弃多线程吗"></a>你应该放弃多线程吗</h2><hr>
<ul>
<li>不能，在高性能服务器上必须有效利用多线程，比如数据库软件。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexiachen.github.io/blog/2018/03/20/why-threads-bad-idea/" data-id="cjtcsryey002hr8qfp3qjvvi8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/线程/">线程</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-stephen-hawking" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/03/14/stephen-hawking/" class="article-date">
  <time datetime="2018-03-14T06:00:00.000Z" itemprop="datePublished">2018-03-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/03/14/stephen-hawking/">霍金</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这位最具有传奇色彩的物理学家去世了，是在圆周率日去世的，这天是爱因斯坦的生日，也是世界顶尖理工大学麻省理工学院发offer的日子。霍金的生日还是伽利略的去世的日子，有人说他是天选之人。</p>
<p>之前发表感慨在微信朋友圈，又觉得不合适，所以删掉了，发到博客上来，以作纪念。</p>
<p>我小时候是看霍金的科普书长大的，印象最深的就是《时间简史》和《果壳中的宇宙》，对于新书《大设计》倒没有怎么细看，豆瓣阅读买了，就堆着书架上了，没来得及。所以我从小是带着对霍金的崇拜长大的。总觉得他是最伟大的物理学家，其他物理学家包括杨振宁，牛顿，爱因斯坦可能都没法与他比肩。他的思想带着我们穿越了时空，甚至到了宇宙之外。我当时就想，没人比他更牛了吧。因为网络上的人都称它为“最后一个爱因斯坦”，“最后的天才”。</p>
<p>后来长大了，念了大学，毕竟受到了理工思维的训练，本着科学客观的怀疑态度，我研究了各大学术网站的一些顶尖大学毕业的物理PhD对霍金在物理史上地位的看法，最后发现，霍金这人在理论物理，宇宙学领域的评价并没有我当年想象中的那么高。相对于杨振宁，<a href="https://en.wikipedia.org/wiki/Edward_Witten" target="_blank" rel="noopener">Edward Witten</a>等理论物理学家，在物理行业人士看来是要差上一筹的。由此我以后评价一个人都会看同样顶尖人士对一个的评价。从此霍金在我心目中的地位被打下了神坛，貌似他并没有那么伟大嘛。</p>
<p>但是就在刚才，我想明白了，其实一个看一个人是否伟大，并不在于他在他那个领域作出了多大成就，获得了几个诺贝尔奖。反而是看他的一生和对年轻一代的影响，从这个角度来看，他带给世界的贡献远远比他带给物理学的贡献要大。他的坎坷一生，他的故事激励着许多年轻人前进，他的科普书把越来越多的年轻人吸引到了物理学的研究中，他把高深的知识用直白的方式带给公众，这几点是他最伟大的地方！ </p>
<p>长江后浪推前浪，说不一定在这些被他影响的年轻人里又再次出现一位改变了物理学界的天才。</p>
<p>他不是继爱因斯坦之后最天才最厉害的物理学家，但他一定是最伟大的物理学家！</p>
<p>终于，在探索万物理论的进程中失去了你。</p>
<p><img src="http://wx1.sinaimg.cn/large/a1ac93f3gy1fpcbg2sd1wj20go0b3aah.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexiachen.github.io/blog/2018/03/14/stephen-hawking/" data-id="cjtcsryeu002ar8qff1pav3nj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/天体物理/">天体物理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/宇宙学/">宇宙学</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/黑洞/">黑洞</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-gallery-processor-cache" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/02/08/gallery-processor-cache/" class="article-date">
  <time datetime="2018-02-08T09:16:53.000Z" itemprop="datePublished">2018-02-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/02/08/gallery-processor-cache/">处理器缓存效果概要</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><hr>
<p>大部分看过<a href="https://book.douban.com/subject/1230413/" target="_blank" rel="noopener">《CSAPP》</a>这本经典的人，一般都能理解CPU缓存的大概机制，并能简单通过CPU的缓存机制来优化程序性能。</p>
<p>我这篇文章主要也是用一些代码样例来从一些不同的角度演示缓存的工作机制和实战中的代码优化。</p>
<h2 id="Example-1：内存访问和性能"><a href="#Example-1：内存访问和性能" class="headerlink" title="Example 1：内存访问和性能"></a>Example 1：内存访问和性能</h2><hr>
<p>比较以下两种不同的循环，哪种循环相对更快？(不用管是什么语言的代码)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>[] arr = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">64</span> * <span class="number">1024</span> * <span class="number">1024</span>]; <span class="comment">// 128MB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Loop 1</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.Length; i++) </span><br><span class="line">    arr[i] *= <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Loop 2</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.Length; i += <span class="number">16</span>) </span><br><span class="line">    arr[i] *= <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<p>如果不出意外，只要写过代码的人，直观上就可以判断出来，哪段更快，很明显，Loop 2中的循环的步长为16，每16个进行一次乘法运算，而Loop 1中是每一个元素都需要进行乘法运算。显然易见，Loop 2只做了Loop 1的工作量的6%（（64/16）/64）。</p>
<p>以上对代码的分析貌似是正确的，但是在现代处理器体系架构下从实际代码运行性能的分析，这两个循环花费的时间差不多（Loop 1是80ms，Loop 2是78ms）。显然Loop 2花费的时间不是Loop 1的6%。为什么？ 怎么与设想的不符呢？</p>
<p>原因是，两个循环都在内存访问上花费了大致相同的时间。运行时花费的代价反而是对数组的内存访问上，而不是循环体内的整型乘法运算。</p>
<h2 id="Example-2-缓存行（Cache-Line）的影响"><a href="#Example-2-缓存行（Cache-Line）的影响" class="headerlink" title="Example 2: 缓存行（Cache Line）的影响"></a>Example 2: 缓存行（Cache Line）的影响</h2><hr>
<p>来，下面我们来对以上例子代码进行一次更深入的探索，循环步长的值不再是1和16了，而把其改为一个变量，设为K：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.Length; i += K) </span><br><span class="line">    arr[i] *= <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<p>对K设不同的值，观察循环性能的变化曲线：</p>
<p><img src="http://wx1.sinaimg.cn/large/a1ac93f3gy1fo92i2adf9j20df0833yj.jpg" alt=""></p>
<p>由上图看到了，K值在1到16之间，性能的变化不明显，耗费的时间都相差不大。</p>
<p>但是，在16以后，步长每增加2倍，运行耗费的时间几乎减半。为什么？</p>
<p>这种现象背后的原因是当今的现代CPU不会一个字节一个字节的访问内存。相反，CPU它一般会直接把内存中相邻的内存以64字节每块（chunk）组成的块状数据取到缓存中，这种就叫缓存行。（64字节算一个缓存行，缓存行可以一次取多个）。当你在读取一个特定的内存地址上的数据的时候，CPU就会把以当前内存地址开始以后的64字节读入到缓存中，所以访问在一个相同的缓存行中的任何数据，所花费的时间都差不多，而且代价小很多。</p>
<p>讲解到这里，你应该就能理解为什么当步长为1和16时，循环所花费的时间差不多了，因为步长1到16之间的数据都在一个相同的缓存行中，16*sizeof(int)=64字节。 正好是一个缓存行。你可以想象CPU已经把这个128MB的数组全部放到了缓存中，每64字节组成一个缓存行。所以步长为32的时候，每一次循环就访问一个新的缓存行，当步长为64的时候，循环以一次每4个缓存行来访问。</p>
<p>所以理解缓存行的机制，对于程序优化很重要。比如，数据对齐可能会决定一个CPU的操作会触碰到1个还是2个缓存行。如果数据没对齐，那么一次取数可能对于CPU要做2次操作。</p>
<h2 id="Example-3-L1-和-L2缓存的大小"><a href="#Example-3-L1-和-L2缓存的大小" class="headerlink" title="Example 3: L1 和 L2缓存的大小"></a>Example 3: L1 和 L2缓存的大小</h2><hr>
<p>当今计算机，一般都有二级缓存了，L1和L2，甚至还有L3缓存了。如果你想知道不同缓存和缓存行的大小，你还需要用工具和系统提供相关的API来细致分析。因为缓存行真不一定是64字节。windows上你可以通过<a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/coreinfo" target="_blank" rel="noopener">CoreInfo</a>这个工具来查看缓存详细信息，或者通过调用<a href="https://msdn.microsoft.com/en-us/library/ms683194\(VS.85\" target="_blank" rel="noopener">GetLogicalProcessorInformation</a>.aspx)这个Win32 API来实现查找缓存相关详情。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">D:\MathxH\tools\Coreinfo&gt;Coreinfo.exe -c -l</span><br><span class="line"></span><br><span class="line">Coreinfo v3.31 - Dump information on system CPU and memory topology</span><br><span class="line">Copyright (C) 2008-2014 Mark Russinovich</span><br><span class="line">Sysinternals - www.sysinternals.com</span><br><span class="line"></span><br><span class="line">Logical to Physical Processor Map:</span><br><span class="line">**--  Physical Processor 0 (Hyperthreaded)</span><br><span class="line">--**  Physical Processor 1 (Hyperthreaded)</span><br><span class="line"></span><br><span class="line">Logical Processor to Cache Map:</span><br><span class="line">**--  Data Cache          0, Level 1,   32 KB, Assoc   8, LineSize  64</span><br><span class="line">**--  Instruction Cache   0, Level 1,   32 KB, Assoc   8, LineSize  64</span><br><span class="line">**--  Unified Cache       0, Level 2,  256 KB, Assoc   8, LineSize  64</span><br><span class="line">****  Unified Cache       1, Level 3,    3 MB, Assoc  12, LineSize  64</span><br><span class="line">--**  Data Cache          1, Level 1,   32 KB, Assoc   8, LineSize  64</span><br><span class="line">--**  Instruction Cache   1, Level 1,   32 KB, Assoc   8, LineSize  64</span><br><span class="line">--**  Unified Cache       2, Level 2,  256 KB, Assoc   8, LineSize  64</span><br></pre></td></tr></table></figure>
<p>在我这台ThinkPad破本上用windows相关命令行查看到的缓存信息是，有三级缓存，并且缓存行的大小都是64字节。32KB的L1数据缓存，32KB的L1指令缓存还有3MB的L3缓存等。</p>
<p>好我们再来分析一下下面的代码程序:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> steps = <span class="number">64</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 64MB</span></span><br><span class="line"><span class="keyword">int</span> lengthMod = arr.Length - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; steps; i++)</span><br><span class="line">&#123;</span><br><span class="line">    arr[(i * <span class="number">16</span>) &amp; lengthMod]++; <span class="comment">// (x &amp; lengthMod) 相当于 (x % arr.Length)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下是以上代码片段随着数组大小增大的性能曲线图:</p>
<p><img src="http://wx1.sinaimg.cn/large/a1ac93f3gy1fobbmcbq3rj20df0833yj.jpg" alt=""></p>
<p>因为L1是32KB, L2是256KB，L3是3MB。所以你可以看到大约在数组大小超过32KB，256KB，3MB或4MB以后会有明显的性能下降，也就是耗费的时间越多。</p>
<h2 id="Example-4-指令级并行"><a href="#Example-4-指令级并行" class="headerlink" title="Example 4 指令级并行"></a>Example 4 指令级并行</h2><hr>
<p>现在，我们来看看一些不一样的地方。以下两个循环，谁会更快？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> steps = <span class="number">256</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">//256MB</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> [] a = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//Loop 1</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; steps; ++i)</span><br><span class="line">&#123;</span><br><span class="line">    a[<span class="number">0</span>]++; <span class="comment">// op1</span></span><br><span class="line">    a[<span class="number">0</span>]++;  <span class="comment">// op2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Loop 2</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; steps; ++i)</span><br><span class="line">&#123;</span><br><span class="line">    a[<span class="number">0</span>]++;  <span class="comment">// op1</span></span><br><span class="line">    a[<span class="number">1</span>]++;  <span class="comment">// op2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很多人一眼看上去貌似是一样快，但是我几乎在所有的机器上测试过，几乎都是Loop 2快过Loop 1。为什么？ 这就需要认真分析两个循环体里面的操作依赖性了。</p>
<p>在Loop 1的循环体中op1和op2是有依赖关系的，op2的操作执行必须等到op1完成才能开始。而Loop 2的循环体中，op1和op2没有依赖关系，理论上可以同时完成，这个就为处理器提供了优化的可行性。</p>
<p>现代处理器对Loop 2这种情况有多种的并发处理方式，他可以在L1缓存中同时访问a[0]和a[1]，并同时执行op1和op2这两个算数运算。但是在Loop 1中，处理器就没有机会利用指令级并行了。</p>
<h2 id="Example-5-缓存相联"><a href="#Example-5-缓存相联" class="headerlink" title="Example 5 缓存相联"></a>Example 5 缓存相联</h2><hr>
<p>在缓存的设计中，有一个关键的决定就是是否要把主内存的每个chunk都存储到每个缓存中，或者只是选择多个缓存的其中几个。</p>
<p>在现代处理器体系中，就有如下几种方式来把多个缓存映射到主内存的块中：</p>
<ul>
<li><p>直接映射缓存，每个内存块只可能被映射到其中一个特定的缓存槽中，是一对一的关系。这种算法就简单的实现方式就是，把主内存的块的index映射到缓存中(chunk index % 缓存槽数)。块下标对缓存槽数取模运算。两个内存块不可能同时都存放在一个相同的缓存槽中。</p>
</li>
<li><p>N路相联缓存（组相联缓存），每一个主内存上的块能被存储到N个特定缓存槽中的其中一个槽中。例如，在16路相联缓存中，每个内存块被存储到特定的16个不同的缓存槽中（16个槽的其中一个）。通常的实现是块的index的最低序列位来表示16个不同的槽</p>
</li>
<li><p>全相联缓存， 每个内存块可能会被存储到任何一个缓存槽中。类似于操作Hash表这样的数据结构。</p>
</li>
</ul>
<p>直接映射缓存容易造成冲突，因为可能会有多个内存块都被映射到相同的内存槽中了，这样会造成缓存频繁的抖动（内存块不停地换入换出，命中率下降）。另一方面，对于全相联缓存比较复杂，硬件实现成本也高。所以N路相联缓存是现代处理器缓存典型的解决方案，它在实现成本和友好的命中率上做了很好的折中和取舍。</p>
<p>例如，在我的电脑上，3MB的L3缓存就是12路相联，32KB的L1缓存和256KB的L2缓存都是8路相联。对于L3缓存，所有的64字节的内存块都会基于自身的index被映射到L3缓存中的特定的12个不同的槽中。</p>
<p>因为L3缓存有4096（2^12 = 4096）个槽，那么每个集合就有12个槽相联,那么就有341个集合。2^8 约等于 341 。 所以chunk index的低8位就决定了这个块存放在那个集合中。</p>
<p>显然，缓存的相联方案也会影响性能，但是这里就不再深入，这方面知识也不是本篇文章的重点。还有一个原因就是我目前暂时不能给大家讲解清楚。</p>
<h2 id="Example-6-缓存行伪共享"><a href="#Example-6-缓存行伪共享" class="headerlink" title="Example 6 缓存行伪共享"></a>Example 6 缓存行伪共享</h2><hr>
<p>在多核机器上，缓存就有遭遇到另一个问题—–并发一致性。不同的核一般来说都有属于自己的缓存。我的机器上L1一般都有属于自己的核，L2是多个核共享的缓存。在现代多核架构中缓存一般有多个层级，速度越快越“接近”核的缓存约属于单个核所有。</p>
<p>当一个核修改了它自身缓存中的一个值的时候，那么其他处理器的核就不能再使用原来的值了，这就导致了缓存失效。</p>
<p>为了演示这个问题，考虑下面的代码样例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] s_counter = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1024</span>];</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateCounter</span><span class="params">(<span class="keyword">int</span> position)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">100000000</span>; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        s_counter[position] = s_counter[position] + <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上这段代码如果在多核机器上，用四个不同的线程分别执行UpdateCounter(0),UpdateCounter(1),UpdateCounter(2),UpdateCounter(3)等到四个线程的结束时所花费的时间记为T1。</p>
<p>如果你用四个线程分别执行UpdateCounter(16),UpdateCounter(32),UpdateCounter(48),UpdateCounter(64)等到四个线程结束时所花费的时间记为T2。</p>
<p>这两种不同的方式比较性能，T2比T1少！</p>
<p>为什么？ 方法一中的0，1，2，3所取的数据几乎都在一个缓存行中，其中一个核每更新计数一次，那么整个缓存行就失效了，那么其他核取数据就cache miss了。如果这样，需要关闭缓存机制。方法二中，是因为不同线程所取的数据在不同的缓存行中，这样就提高了并发量</p>
<h2 id="Example-7-硬件复杂性"><a href="#Example-7-硬件复杂性" class="headerlink" title="Example 7 硬件复杂性"></a>Example 7 硬件复杂性</h2><hr>
<p>好吧，即使你完全了解之前所讲述的缓存机制，但是在实战中，还不一定照葫芦画瓢就能轻而易举通过优化程序提高性能，一些个别的硬件体系在有些时候还是会使你震惊，不同处理器架构的优化手段也不尽相同。</p>
<p>比如，在有些处理器架构中，L1缓存可以存在并行（如果从不同卡槽来访问），如果是来自相同卡槽的访问那么L1缓存就可能是顺序访问了。有时候，处理器作出的优化，也能让你吃惊，你的优化是多余的。 :) </p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><hr>
<p> 还是不喜欢通过缓存特性来优化程序，虽然很多高性能的网络框架用到了这些缓存的原理，但是我还是喜欢算法级别的优化。原因就是Example 7，由于硬件的复杂性，很难写出跨平台的缓存利用友好的高性能程序，也很难根据硬件特性来预测程序性能。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexiachen.github.io/blog/2018/02/08/gallery-processor-cache/" data-id="cjtcsrygw0071r8qf0jkg7q6p" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/性能优化/">性能优化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/缓存/">缓存</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/计算机体系结构/">计算机体系结构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-cert-java-zero" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/15/cert-java-zero/" class="article-date">
  <time datetime="2017-12-15T09:16:53.000Z" itemprop="datePublished">2017-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/15/cert-java-zero/">CERT Java编码规范翻译（DCL）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h1><hr>
<p>本文翻译自<a href="http://www.cert.org/" target="_blank" rel="noopener">CERT</a>(计算机安全应急响应组)提供的Java安全编码规范，与其他规范不一样的是，该规范侧重软件安全的编码规范。翻译不完全逐字段翻译，可能有简化删改。文章分为规则（Rules）和建议（Recommendations）部分。前者是规则，程序员需要遵循的，后者是推荐，意在强烈建议那样做（How）。</p>
<p>为了简化文章子标题，Recommendation用Rec简写。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><hr>
<h2 id="Rule-00-输入校验和数据卫生处理（IDS）"><a href="#Rule-00-输入校验和数据卫生处理（IDS）" class="headerlink" title="Rule 00. 输入校验和数据卫生处理（IDS）"></a>Rule 00. 输入校验和数据卫生处理（IDS）</h2><h3 id="IDS00-J-防止SQL注入"><a href="#IDS00-J-防止SQL注入" class="headerlink" title="IDS00-J. 防止SQL注入"></a>IDS00-J. 防止SQL注入</h3><p>严重等级： 高</p>
<ul>
<li>在用户输入之后和存储数据之前，需要对输入的数据进行校验，如果不这么做，会导致注入攻击。</li>
</ul>
<p>比如，<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-2370" target="_blank" rel="noopener">CVE-2008-2370</a>这个爆出的漏洞叫描述了这样的一个脆弱性，在Apache tomcat 4.1.0到4.1.47， 5.5.0到5.5.26还有6.0.0到6.0.16都发现了这样的漏洞。</p>
<h4 id="代码样例对比"><a href="#代码样例对比" class="headerlink" title="代码样例对比"></a>代码样例对比</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    DriverManager.registerDriver(<span class="keyword">new</span></span><br><span class="line">            com.microsoft.sqlserver.jdbc.SQLServerDriver());</span><br><span class="line">    String dbConnection =</span><br><span class="line">      PropertyManager.getProperty(<span class="string">"db.connection"</span>);</span><br><span class="line">    <span class="comment">// Can hold some value like</span></span><br><span class="line">    <span class="comment">// "jdbc:microsoft:sqlserver://&lt;HOST&gt;:1433,&lt;UID&gt;,&lt;PWD&gt;"</span></span><br><span class="line">    <span class="keyword">return</span> DriverManager.getConnection(dbConnection);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function">String <span class="title">hashPassword</span><span class="params">(<span class="keyword">char</span>[] password)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Create hash of password</span></span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPrivilegedAction</span><span class="params">(String username, <span class="keyword">char</span>[] password)</span></span></span><br><span class="line"><span class="function">                                 <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    Connection connection = getConnection();</span><br><span class="line">    <span class="keyword">if</span> (connection == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Handle error</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      String pwd = hashPassword(password);</span><br><span class="line"> </span><br><span class="line">      String sqlString = <span class="string">"SELECT * FROM db_user WHERE username = '"</span></span><br><span class="line">                         + username +</span><br><span class="line">                         <span class="string">"' AND password = '"</span> + pwd + <span class="string">"'"</span>;</span><br><span class="line">      Statement stmt = connection.createStatement();</span><br><span class="line">      ResultSet rs = stmt.executeQuery(sqlString);</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span> (!rs.next()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">          <span class="string">"User name or password incorrect"</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Authenticated; proceed</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        connection.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SQLException x) &#123;</span><br><span class="line">        <span class="comment">// Forward to handler</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上的代码用JDBC对一个用户进入系统进行验证，password是char型数组，当然，密码用Hash来保存进数据库了，一般来说，开发者都会这么做，密码禁止明文保存嘛，所以pwd字段显然不会被注入。但是这个代码没有处理username字段，导致用户在输入用户名的时候可以构造非法字符串来进行SQL注入攻击，比如在该字段注入一个validuser’ OR ‘1’=’1 。<br>最终的SQL语句拼接的结果为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> db_user <span class="keyword">WHERE</span> username=<span class="string">'validuser'</span> <span class="keyword">OR</span> <span class="string">'1'</span>=<span class="string">'1'</span> <span class="keyword">AND</span> <span class="keyword">password</span>=<span class="string">'&lt;PASSWORD&gt;'</span></span><br></pre></td></tr></table></figure>
<p>这样SQL语句就跳过password的，直接可以获取validuser的相关信息，包括密码。</p>
<p>当然，有点经验的Java程序员可能会这么做，用JDBC提供的一个构建SQL命令的API（PreparedStatement）来处理非信任的数据，于是乎写出以下代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    DriverManager.registerDriver(<span class="keyword">new</span></span><br><span class="line">            com.microsoft.sqlserver.jdbc.SQLServerDriver());</span><br><span class="line">    String dbConnection =</span><br><span class="line">      PropertyManager.getProperty(<span class="string">"db.connection"</span>);</span><br><span class="line">    <span class="comment">// Can hold some value like</span></span><br><span class="line">    <span class="comment">// "jdbc:microsoft:sqlserver://&lt;HOST&gt;:1433,&lt;UID&gt;,&lt;PWD&gt;"</span></span><br><span class="line">    <span class="keyword">return</span> DriverManager.getConnection(dbConnection);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function">String <span class="title">hashPassword</span><span class="params">(<span class="keyword">char</span>[] password)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Create hash of password</span></span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPrivilegedAction</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    String username, <span class="keyword">char</span>[] password</span></span></span><br><span class="line"><span class="function"><span class="params">  )</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    Connection connection = getConnection();</span><br><span class="line">    <span class="keyword">if</span> (connection == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Handle error</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      String pwd = hashPassword(password);</span><br><span class="line">      String sqlString = <span class="string">"select * from db_user where username="</span> +</span><br><span class="line">        username + <span class="string">" and password ="</span> + pwd;     </span><br><span class="line">      PreparedStatement stmt = connection.prepareStatement(sqlString);</span><br><span class="line"> </span><br><span class="line">      ResultSet rs = stmt.executeQuery();</span><br><span class="line">      <span class="keyword">if</span> (!rs.next()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"User name or password incorrect"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Authenticated; proceed</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        connection.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SQLException x) &#123;</span><br><span class="line">        <span class="comment">// Forward to handler</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上的代码看起来对了，但是还是阻止不了SQL注入，还是可以攻击username字段，原因是PreparedStatement使用不正确。正确的写法应该是以下代码，减轻防止了SQL注入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPrivilegedAction</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  String username, <span class="keyword">char</span>[] password</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  Connection connection = getConnection();</span><br><span class="line">  <span class="keyword">if</span> (connection == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Handle error</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    String pwd = hashPassword(password);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Validate username length</span></span><br><span class="line">    <span class="keyword">if</span> (username.length() &gt; <span class="number">8</span>) &#123;</span><br><span class="line">      <span class="comment">// Handle error</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    String sqlString =</span><br><span class="line">      <span class="string">"select * from db_user where username=? and password=?"</span>;</span><br><span class="line">    PreparedStatement stmt = connection.prepareStatement(sqlString);</span><br><span class="line">    stmt.setString(<span class="number">1</span>, username);</span><br><span class="line">    stmt.setString(<span class="number">2</span>, pwd);</span><br><span class="line">    ResultSet rs = stmt.executeQuery();</span><br><span class="line">    <span class="keyword">if</span> (!rs.next()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"User name or password incorrect"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Authenticated; proceed</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      connection.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException x) &#123;</span><br><span class="line">      <span class="comment">// Forward to handler</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上的代码防止了SQL的注入，同时还禁止了用户输入过长的用户名。用了PreparedStatement类的setXXXX()的方法，会强制进行强类型检查，所以当username出现不合法的符号的时候，直接作出相应处理。</p>
<h3 id="IDS01-J-在校验字符串之前先规格化（标准化）字符串"><a href="#IDS01-J-在校验字符串之前先规格化（标准化）字符串" class="headerlink" title="IDS01-J. 在校验字符串之前先规格化（标准化）字符串"></a>IDS01-J. 在校验字符串之前先规格化（标准化）字符串</h3><p>严重等级： 高</p>
<ul>
<li>如果不这样做，可能会导致异常执行非法代码</li>
</ul>
<p>许多Web应用会使用String来表示校验机制，比如正则表达式校验输入合不合法，校验输入框输入的非法字符串作出相应处理。例如，禁止\&lt;script> 标签出现在输入框中，防止跨站脚本(XSS)攻击，还有一些黑名单的校验机制也是这么做。</p>
<p>Java中的字符信息是基于Unicode标准的，</p>
<ul>
<li>Java SE 6是Unicode 4.0 </li>
<li>Java SE 7是Unicode 6.0.0 </li>
<li>Java SE 8是Unicode 6.0.2</li>
</ul>
<p>所以应用在接收未经过信任的输入String需要在校验之前把String做规范化，规范化在Unicode标准中是非常重要的，因为同样显示出来的String可能底层有不同的二进制表示。</p>
<p>根据Unicode标准<a href="https://wiki.sei.cmu.edu/confluence/display/java/Rule+AA.+References#RuleAA.References-Davis08" target="_blank" rel="noopener">Davis 2008</a>, annex #15，Unicode的标准化形式：</p>
<blockquote>
<p>When implementations keep strings in a normalized form, they can be assured that equivalent strings have a unique binary representation.</p>
</blockquote>
<h4 id="代码样例对比-1"><a href="#代码样例对比-1" class="headerlink" title="代码样例对比"></a>代码样例对比</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// String s may be user controllable</span></span><br><span class="line"><span class="comment">// \uFE64 is normalized to &lt; and \uFE65 is normalized to &gt; using the NFKC normalization form</span></span><br><span class="line">String s = <span class="string">"\uFE64"</span> + <span class="string">"script"</span> + <span class="string">"\uFE65"</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Validate</span></span><br><span class="line">Pattern pattern = Pattern.compile(<span class="string">"[&lt;&gt;]"</span>); <span class="comment">// Check for angle brackets</span></span><br><span class="line">Matcher matcher = pattern.matcher(s);</span><br><span class="line"><span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">  <span class="comment">// Found black listed tag</span></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Normalize</span></span><br><span class="line">s = Normalizer.normalize(s, Form.NFKC);</span><br></pre></td></tr></table></figure>
<p>以上的代码script字符串在进行正则表达式校验匹配之前显然没有规范化，Normalize放到了校验之后，结果就会导致很可能校验会失败，绕过系统验证了，然后导致XSS。这个规范采用的是KC规范。Normalizer.normalize()方法是把Unicode文本转化为标准的规范格式，这个在<a href="http://www.unicode.org/reports/tr15/tr15-23.html" target="_blank" rel="noopener">Unicode Standard Annex #15 Unicode Normalization Forms</a>中有描述。</p>
<p>解决方案很简单，提前规范化就可以了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">"\uFE64"</span> + <span class="string">"script"</span> + <span class="string">"\uFE65"</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Normalize</span></span><br><span class="line">s = Normalizer.normalize(s, Form.NFKC);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Validate</span></span><br><span class="line">Pattern pattern = Pattern.compile(<span class="string">"[&lt;&gt;]"</span>);</span><br><span class="line">Matcher matcher = pattern.matcher(s);</span><br><span class="line"><span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">  <span class="comment">// Found blacklisted tag</span></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IDS03-J-不要用log输出未经过处理的用户输入"><a href="#IDS03-J-不要用log输出未经过处理的用户输入" class="headerlink" title="IDS03-J. 不要用log输出未经过处理的用户输入"></a>IDS03-J. 不要用log输出未经过处理的用户输入</h3><p>严重等级：中等</p>
<p>可能会导致敏感信息(不该被人知道的用户名或者密码等)被泄漏，这个条款没多少可以讲解的。</p>
<h4 id="代码样例对比-2"><a href="#代码样例对比-2" class="headerlink" title="代码样例对比"></a>代码样例对比</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (loginSuccessful) &#123;</span><br><span class="line">  logger.severe(<span class="string">"User login succeeded for: "</span> + username);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  logger.severe(<span class="string">"User login failed for: "</span> + username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以用以下两种解决方案就可以了，要么处理相应的用户输入，要么处理log函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">sanitizeUser</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Pattern.matches(<span class="string">"[A-Za-z0-9_]+"</span>, username))</span><br><span class="line">      ? username : <span class="string">"unauthorized user"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (loginSuccessful) &#123;</span><br><span class="line">  logger.severe(<span class="string">"User login succeeded for: "</span> + sanitizeUser(username));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  logger.severe(<span class="string">"User login failed for: "</span> + sanitizeUser(username));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SanitizedTextLogger</span> <span class="keyword">extends</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">  Logger delegate;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SanitizedTextLogger</span><span class="params">(Logger delegate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(delegate.getName(), delegate.getResourceBundleName());</span><br><span class="line">    <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">sanitize</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    Pattern newline = Pattern.compile(<span class="string">"\n"</span>);</span><br><span class="line">    Matcher matcher = newline.matcher(msg);</span><br><span class="line">    <span class="keyword">return</span> matcher.replaceAll(<span class="string">"\n  "</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">severe</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    delegate.severe(sanitize(msg));</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// .. Other Logger methods which must also sanitize their log messages</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Logger sanLogger = <span class="keyword">new</span> SanitizedTextLogger(logger);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (loginSuccessful) &#123;</span><br><span class="line">  sanLogger.severe(<span class="string">"User login succeeded for: "</span> + username);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  sanLogger.severe(<span class="string">"User login failed for: "</span> + username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IDS04-J-安全的从ZipInputStream中抽取文件"><a href="#IDS04-J-安全的从ZipInputStream中抽取文件" class="headerlink" title="IDS04-J. 安全的从ZipInputStream中抽取文件"></a>IDS04-J. 安全的从ZipInputStream中抽取文件</h3><p>严重等级：低</p>
<p>这个条款的细节要掌握比较难。</p>
<p>Java提供java.util.zip包来处理zip兼容的数据压缩，该包所含的类可以让用户轻松读取，创建，修改ZIP和GZIP压缩文件格式。</p>
<p>当使用java.util.zip.ZipInputStream类来抽取ZIP文件中的Items的时候需要注意一些安全问题。文件名携带的路径可能会直接覆盖系统中的重要文件，这些都需要注意。</p>
<p>第二个关注点就是，解压ZIP文件的过程，很消耗系统资源，可能由于资源的使用过多导致服务拒绝攻击(Dos)，ZIP算法有很高的压缩率，非常占用资源。一个例子就是网络上流传的ZIP炸弹(ZIP Bomb),<a href="http://www.unforgettable.dk/" target="_blank" rel="noopener">42KB大小的ZIP文件</a>包含了上PB级别的信息量。至于怎么做到的，看官网解释:</p>
<blockquote>
<p>The<br> file contains 16 zipped files, which again contains 16 zipped files,<br>which again contains 16 zipped files, which again contains 16 zipped,<br>which again contains 16 zipped files, which contain 1 file, with the<br>size of 4.3GB.</p>
</blockquote>
<p>这个压缩文件中包含16个压缩文件，这样递归下去有5个层级，也就是16^5=1048576个压缩文件，每个压缩文件里面包含一个4.3GB文件，4.3GB * 1048576 = 4.5PB</p>
<p>所以代码需要限制约束。</p>
<h4 id="代码样例对比-3"><a href="#代码样例对比-3" class="headerlink" title="代码样例对比"></a>代码样例对比</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER = <span class="number">512</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">unzip</span><span class="params">(String filename)</span> <span class="keyword">throws</span> java.io.IOException</span>&#123;</span><br><span class="line">  FileInputStream fis = <span class="keyword">new</span> FileInputStream(filename);</span><br><span class="line">  ZipInputStream zis = <span class="keyword">new</span> ZipInputStream(<span class="keyword">new</span> BufferedInputStream(fis));</span><br><span class="line">  ZipEntry entry;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> ((entry = zis.getNextEntry()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      System.out.println(<span class="string">"Extracting: "</span> + entry);</span><br><span class="line">      <span class="keyword">int</span> count;</span><br><span class="line">      <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER];</span><br><span class="line">      <span class="comment">// Write the files to the disk</span></span><br><span class="line">      FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(entry.getName());</span><br><span class="line">      BufferedOutputStream dest = <span class="keyword">new</span> BufferedOutputStream(fos, BUFFER);</span><br><span class="line">      <span class="keyword">while</span> ((count = zis.read(data, <span class="number">0</span>, BUFFER)) != -<span class="number">1</span>) &#123;</span><br><span class="line">        dest.write(data, <span class="number">0</span>, count);</span><br><span class="line">      &#125;</span><br><span class="line">      dest.flush();</span><br><span class="line">      dest.close();</span><br><span class="line">      zis.closeEntry();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    zis.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码在未进过检验文件大小的情况下，直接在FileOutputStream的构造器里面传入了Name，可能导致本机计算机资源消耗殆尽。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER = <span class="number">512</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TOOBIG = <span class="number">0x6400000</span>; <span class="comment">// 100MB</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">unzip</span><span class="params">(String filename)</span> <span class="keyword">throws</span> java.io.IOException</span>&#123;</span><br><span class="line">  FileInputStream fis = <span class="keyword">new</span> FileInputStream(filename);</span><br><span class="line">  ZipInputStream zis = <span class="keyword">new</span> ZipInputStream(<span class="keyword">new</span> BufferedInputStream(fis));</span><br><span class="line">  ZipEntry entry;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> ((entry = zis.getNextEntry()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      System.out.println(<span class="string">"Extracting: "</span> + entry);</span><br><span class="line">      <span class="keyword">int</span> count;</span><br><span class="line">      <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER];</span><br><span class="line">      <span class="comment">// Write the files to the disk, but only if the file is not insanely big</span></span><br><span class="line">      <span class="keyword">if</span> (entry.getSize() &gt; TOOBIG ) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"File to be unzipped is huge."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (entry.getSize() == -<span class="number">1</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"File to be unzipped might be huge."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(entry.getName());</span><br><span class="line">      BufferedOutputStream dest = <span class="keyword">new</span> BufferedOutputStream(fos, BUFFER);</span><br><span class="line">      <span class="keyword">while</span> ((count = zis.read(data, <span class="number">0</span>, BUFFER)) != -<span class="number">1</span>) &#123;</span><br><span class="line">        dest.write(data, <span class="number">0</span>, count);</span><br><span class="line">      &#125;</span><br><span class="line">      dest.flush();</span><br><span class="line">      dest.close();</span><br><span class="line">      zis.closeEntry();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    zis.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上检查了抽取的entry大小，作出了相应处理判断，但是没有对抽取的数量做判断，也没有校验文件名，可能会覆盖其他重要的文件，所以最终方案是以下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER = <span class="number">512</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TOOBIG = <span class="number">0x6400000</span>; <span class="comment">// Max size of unzipped data, 100MB</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TOOMANY = <span class="number">1024</span>;      <span class="comment">// Max number of files</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">validateFilename</span><span class="params">(String filename, String intendedDir)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">  File f = <span class="keyword">new</span> File(filename);</span><br><span class="line">  String canonicalPath = f.getCanonicalPath();</span><br><span class="line"> </span><br><span class="line">  File iD = <span class="keyword">new</span> File(intendedDir);</span><br><span class="line">  String canonicalID = iD.getCanonicalPath();</span><br><span class="line">   </span><br><span class="line">  <span class="keyword">if</span> (canonicalPath.startsWith(canonicalID)) &#123;</span><br><span class="line">    <span class="keyword">return</span> canonicalPath;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"File is outside extraction target directory."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">unzip</span><span class="params">(String filename)</span> <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">  FileInputStream fis = <span class="keyword">new</span> FileInputStream(filename);</span><br><span class="line">  ZipInputStream zis = <span class="keyword">new</span> ZipInputStream(<span class="keyword">new</span> BufferedInputStream(fis));</span><br><span class="line">  ZipEntry entry;</span><br><span class="line">  <span class="keyword">int</span> entries = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">long</span> total = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> ((entry = zis.getNextEntry()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      System.out.println(<span class="string">"Extracting: "</span> + entry);</span><br><span class="line">      <span class="keyword">int</span> count;</span><br><span class="line">      <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER];</span><br><span class="line">      <span class="comment">// Write the files to the disk, but ensure that the filename is valid,</span></span><br><span class="line">      <span class="comment">// and that the file is not insanely big</span></span><br><span class="line">      String name = validateFilename(entry.getName(), <span class="string">"."</span>);</span><br><span class="line">      <span class="keyword">if</span> (entry.isDirectory()) &#123;</span><br><span class="line">        System.out.println(<span class="string">"Creating directory "</span> + name);</span><br><span class="line">        <span class="keyword">new</span> File(name).mkdir();</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(name);</span><br><span class="line">      BufferedOutputStream dest = <span class="keyword">new</span> BufferedOutputStream(fos, BUFFER);</span><br><span class="line">      <span class="keyword">while</span> (total + BUFFER &lt;= TOOBIG &amp;&amp; (count = zis.read(data, <span class="number">0</span>, BUFFER)) != -<span class="number">1</span>) &#123;</span><br><span class="line">        dest.write(data, <span class="number">0</span>, count);</span><br><span class="line">        total += count;</span><br><span class="line">      &#125;</span><br><span class="line">      dest.flush();</span><br><span class="line">      dest.close();</span><br><span class="line">      zis.closeEntry();</span><br><span class="line">      entries++;</span><br><span class="line">      <span class="keyword">if</span> (entries &gt; TOOMANY) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Too many files to unzip."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (total + BUFFER &gt; TOOBIG) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"File being unzipped is too big."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    zis.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IDS06-J-从格式化字符串中排除未经过安全处理的用户输入"><a href="#IDS06-J-从格式化字符串中排除未经过安全处理的用户输入" class="headerlink" title="IDS06-J. 从格式化字符串中排除未经过安全处理的用户输入"></a>IDS06-J. 从格式化字符串中排除未经过安全处理的用户输入</h3><p>严重程度： 中等</p>
<p>未经过信任的数据交织在格式化字符串中容易导致信息泄漏，容易导致服务拒绝攻击(Dos)。</p>
<p>java.io包里面包含的PrintStream类有两个等价的格式化方法：format()和printf()。System.out和System.err是PrintStream的方法，它允许调用标准输出流和标准错误流。使用这两个方法的风险跟C/C++的printf类似。</p>
<h4 id="代码样例对比-4"><a href="#代码样例对比-4" class="headerlink" title="代码样例对比"></a>代码样例对比</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Format</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> Calendar c = <span class="keyword">new</span> GregorianCalendar(<span class="number">1995</span>, GregorianCalendar.MAY, <span class="number">23</span>);</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; </span><br><span class="line">    <span class="comment">// args[0] should contain the credit card expiration date</span></span><br><span class="line">    <span class="comment">// but might contain %1$tm, %1$te or %1$tY format specifiers</span></span><br><span class="line">    System.out.format(</span><br><span class="line">      args[<span class="number">0</span>] + <span class="string">" did not match! HINT: It was issued on %1$terd of some month"</span>, c</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上有注入风险，一旦args[0]输入的是特殊的格式符号，那么就造成了对象c的信息泄漏了，直接就把正确的日期信息打印出来了</p>
<p>所以需要改成以下代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Format</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> Calendar c =</span><br><span class="line">    <span class="keyword">new</span> GregorianCalendar(<span class="number">1995</span>, GregorianCalendar.MAY, <span class="number">23</span>);</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; </span><br><span class="line">    <span class="comment">// args[0] is the credit card expiration date</span></span><br><span class="line">    <span class="comment">// Perform comparison with c,</span></span><br><span class="line">    <span class="comment">// if it doesn't match, print the following line</span></span><br><span class="line">    System.out.format(</span><br><span class="line">      <span class="string">"%s did not match! HINT: It was issued on %terd of some month"</span>, </span><br><span class="line">      args[<span class="number">0</span>], c</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然以上代码可能还可以包含特殊的格式符号，但是这样的做法，特殊格式的符号无效了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexiachen.github.io/blog/2017/12/15/cert-java-zero/" data-id="cjtcsryhe008fr8qfkg8hevko" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/CERT/">CERT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Oracle/">Oracle</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-kunming-project-manager" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/10/kunming-project-manager/" class="article-date">
  <time datetime="2017-12-10T01:16:53.000Z" itemprop="datePublished">2017-12-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/10/kunming-project-manager/">论昆明的项目经理与北京的差异</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><hr>
<p>如果看过我博客的读者，可能记得曾经我写过的一篇文章叫<a href="https://alexiachen.github.io/blog/2016/08/31/tech-leader/">《谈谈技术领导者的基本素养》</a>, 主要谈论的是在北京工作3年出头的感受，对遇到的或者是听到过的技术领导，技术组长，或是项目经理的基本素养能力作出的评价认可。  </p>
<p>我去年从北京回来昆明与媳妇一起生活，到现在算一算，已经一年多点了，我想谈谈我工作中接触过的一些人和事的想法与感受。特别是昆明这边项目经理这个角色与北京大小公司的项目经理有些什么不同。当然，这些不同可能是我在昆明初来乍到，运气不好，碰到的个例也说不准。</p>
<p>注，这里的项目经理特指IT软件这方面的<a href="https://en.wikipedia.org/wiki/Project_manager#Software_Project_Manager/IT_Project_Manager" target="_blank" rel="noopener">项目经理</a>。</p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><hr>
<h3 id="1-很有可能不是技术出身"><a href="#1-很有可能不是技术出身" class="headerlink" title="1. 很有可能不是技术出身"></a><strong>1. 很有可能不是技术出身</strong></h3><p>这个是我最直观的感受，昆明这边的项目经理技术普遍不强，这进一步导致了与一线开发增加了很大的沟通成本，即使项目经理对技术细节的把控已经没有那么重要了，但是如果不能与一线的开发人员进行有效的沟通，那么会造成项目进行缓慢，不能正常交付。一线工程师也会不服气这样的人来管控项目。</p>
<p>相比其北京的项目经理，昆明的IT企业这方面的招聘规范化就不行，不成体系，乱作一团。貌似只要有点管理项目的水平就可以带开发团队一样。甚至有一家公司的“项目经理”只会点SQL语句。</p>
<h3 id="2-离一线开发越来越远，越来越把握不住问题的关键点"><a href="#2-离一线开发越来越远，越来越把握不住问题的关键点" class="headerlink" title="2. 离一线开发越来越远，越来越把握不住问题的关键点"></a><strong>2. 离一线开发越来越远，越来越把握不住问题的关键点</strong></h3><p>昆明的科班或是技术出身的项目经理，因为工作了差不多10年了，一般来说已经对技术毫无热情可言了，业余不会写代码和学习新的技术，设计思想。总觉得项目管理本质就是把控风险和把控时间节点，只要是理论上可行，任务拆分的合理，自己也稍微凭着以往的开发经验懂点技术，项目的预期交付就不会有难度。呵呵，我只能说理想很丰满，现实很骨干，显然不是这么一回事。但是，重点就是以往的开发经验对于现在的IT技术体系已经能复用的不是很多了，而且，从当前现有资源的情况下，最清楚当前问题所在的关键点往往是工程师自己，因为代码是他们一行一行的写出来的。如果项目经理不能从这些反馈的问题中抓住问题的关键，那就不是一个合格的项目经理，项目经理如果业余不经常写点代码，这样会导致项目经理越来越把握不住一线工程师反馈的问题关键点，项目不能有效进行，这样的后果就是走弯路，长期下来工程师没干劲，最后散伙。</p>
<p>昆明这边的项目经理的一个现象就是，当工程师反馈问题的时候，他不能有理有据的引导帮助你解决问题，也不能说服你，也不拿出方案来，而是说，我当年做过，简单，自己下去想吧。完毕，然后，分配拆分任务，坐在工位上时不时玩玩手机，嘻嘻哈哈笑一笑，解决技术问题的能力太弱。你说一线工程师看到这样的项目经理会怎么想？</p>
<p>反之，我在北京工作过的所有公司，没有哪个项目经理业余不写代码，保持对技术的热爱的，几乎没有。他们上能技术选型，下能从技术细节问题中剥离出问题的关键点，引导和指导队友顺利解决问题，甚至有时候亲自加班解决，让队友口服心服。</p>
<p>腾讯公司的很多<a href="https://www.zhihu.com/question/29910703" target="_blank" rel="noopener">T4专家工程师</a>,技术总监还在业余写代码呢，有家室的也不少，照样业余写代码，看论文,还解决公司项目最关键最难的技术问题。其中<a href="https://www.zhihu.com/people/miloyip/" target="_blank" rel="noopener">Milo Yip</a>就是我说的之一，他无论演讲和把控细节，总能服人。实至名归。呵呵，只有实力达到了，你的名气和权威自然就来了，队友自然也就服气了。</p>
<p>不知道怎么回事，昆明这边的项目经理这个角色发展，越来越与技术分家，项目经理越来越偏管理角色，这绝对是不好的现象。</p>
<h3 id="3-团队沟通的时候，基本概念张冠李戴"><a href="#3-团队沟通的时候，基本概念张冠李戴" class="headerlink" title="3. 团队沟通的时候，基本概念张冠李戴"></a><strong>3. 团队沟通的时候，基本概念张冠李戴</strong></h3><p>这个第三个现象，主要就是我现在这个开发组（开始共3个人，后来辞职了一个，现在只剩我和他了）的“项目经理”有的问题，当然，同时他也有第二个问题，只是我拿来第三点来举例子。而且，第三点的问题，他非常明显。</p>
<p>这点体现出来的问题，可以总结为一句话，“不专业，基础不扎实”。</p>
<p>我们回到沟通，讨论这个最基本的问题上，大家都知道，沟通和讨论是要出一个结果的，带有目的性的。是要有理有据的。而需要完好的达到目的和预期的结果，是要有个讨论的基础知识点的，这些基础点往往是专业知识，这些基本概念知识一定不能张冠李戴，鸡同鸭讲，在这个基础层面上参与讨论的人，任何一个人一定不能对这些基础点理解有错误，不然根本不可能讨论出结果，他会认为他自己是对的，你也会认为你是对的。如果出现这样的现象，讨论全都得推翻重来。这样就像做数学证明题一样，<a href="https://baike.baidu.com/item/%E5%85%AC%E7%90%86" target="_blank" rel="noopener">公理</a>一般是不需要证明的，一般是大家一致认可的。<a href="https://baike.baidu.com/item/%E5%AE%9A%E7%90%86/9488549" target="_blank" rel="noopener">定理</a>是定义的，满足某些前提，并且可以被证明的。在公理系统中，公理是前提假设，定理由公理证明，公理本身没有前提条件，是一切定理的最终的前提条件。讨论沟通的实质跟数学上的证明几乎没太大区别。所以沟通，讨论一定要对这些最基本的概念认可一致，讨论才会有结果。专业基本概念一定不能鸡同鸭讲，张冠李戴。</p>
<p>举个例子，如果让一个网络工程师分析一个TCP/IP的问题，如果他连TCP是面向流的，可靠的传输协议，他的可靠性是怎么保证的这些基础知识点都理不清楚，他还能分析出结果吗？ 即使最后他解决了，也是撞大运撞上的，这样的现象我在北京有类似的遇到过，专业点大家都叫“<font color="red">结论是对的，但推理过程错了</font>” 。通俗一点就是“瞎猫碰见死耗子”。当然对于打死不承认的人他会自圆其说，美名其曰叫“经验，直觉”。</p>
<p>再举个现实例子，昆明现实中这位我说的“项目经理”在讨论沟通中是怎样的表现？</p>
<p>他在讨论中，几乎分不清抽象，封装，继承，多态，接口这些面向对象的概念，它把什么东西几乎都说成封装，他完全搞不清楚这些概念有什么关系和区别，也不知道为什么会搞出这么多概念来，从他行为的表象来看，他对这些概念满不在乎，可能他内心甚至认为，这些概念不重要，只要他说出来，工程师能理解他的话要表达的意思就行了，这样长期讨论下来，后果就是一些基础薄弱的工程师直接会被他带歪了，影响前程。基础好的工程师，直接不服这么一个项目经理，讨论不出结果，在团队中受气，最后离职走人。</p>
<p>他还有个基础知识点，与广大的我在北京遇到的开发工程师不一样的地方就是，他不太清楚异常和返回错误的区别，以及它们的好处和坏处。他认为异常不能用得太宽泛，大部分应该用错误码，说异常是代码层面的问题，错误码是逻辑层面的问题。当然，他给出的这个解释，我认识的开发工程师都听不明白，我也听不明白。这个当前项目是应用层项目，不是C语言的嵌入式底层，代码量很大，有大量的代码是靠堆逻辑的，如果用错误码，显然是不现实的，代码逻辑与错误处理不能良好分开，反而混杂在一块，形成<a href="https://zhuanlan.zhihu.com/p/29020657" target="_blank" rel="noopener">面条代码</a>。而且，对于返回错误的形式，上层调用代码的开发人员可能会忘记判断返回值了，但是代码还在继续运行，这样离代码出错点越来越远，线上出了问题都不好Debug。如果用异常，特别对于Java这样的<a href="https://en.wikipedia.org/wiki/Exception_handling#Checked_exceptions" target="_blank" rel="noopener">Checked Exception</a>语言，直接就可以从编译期来检查你是否try catch了可能出异常的地方，从根本上就杜绝了问题，进一步扩散。如果用C++，即使它不是Checked Exception，如果你没有try catch，当异常抛到最顶层还不处理的话，程序直接就崩溃了，这样问题倒反更好查，问题范围不会扩大。</p>
<p>当然，异常相比错误码的好处，在有大量逻辑堆砌的代码中利大于弊，知乎有更详细的<a href="https://www.zhihu.com/question/26158399" target="_blank" rel="noopener">讨论</a>了，还有一个<a href="https://www.zhihu.com/question/27122172" target="_blank" rel="noopener">讨论</a>。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><hr>
<p>说了这么多了，并不是故意找某个人的茬，只是想说明一个现象，昆明的整体IT行业有待提高，企业的规范性，从业人员的专业素养都有待提高。自己也时刻提醒自己，不要变成自己不想成为的人。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexiachen.github.io/blog/2017/12/10/kunming-project-manager/" data-id="cjtcsrygy0075r8qf40r3w50q" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/团队管理/">团队管理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/软件工程/">软件工程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/项目管理/">项目管理</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-remote-desktop" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/01/remote-desktop/" class="article-date">
  <time datetime="2017-12-01T01:41:15.000Z" itemprop="datePublished">2017-12-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/01/remote-desktop/">关于远程桌面的简要调研报告</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><hr>
<p>这篇调研报告原本是公司在今年四月份做的调研，当时是总结了篇Word文档，由于我有经常写博客和翻阅博客的习惯，所以发到这里，以方面查阅和回顾。</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><hr>
<p>远程桌面原本是从Windows 2000 Server开始由微软公司提供的，它的功能是当某台计算机开启了远程桌面服务后我们就可以在网络的另一端控制这台计算机了，通过远程桌面功能我们可以实时的操作这台计算机，在上面安装软件，运行程序，所有的一切都好像是直接在该计算机上操作一样。这就是远程桌面的最大功能。</p>
<h2 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a>技术方案</h2><hr>
<p>远程桌面控制来源于微软，它可以有多种实现方式，网络上常见的一种就是Virtual Network Computing，也就是通常所说的<a href="https://en.wikipedia.org/wiki/Virtual_Network_Computing" target="_blank" rel="noopener">VNC</a>，VNC是采用<a href="https://en.wikipedia.org/wiki/RFB_protocol" target="_blank" rel="noopener">RFB(remote frame buffer)</a>协议图形化的桌面共享系统,它可以远程控制其他电脑。VNC在网络上有很多开源实现，比如<a href="https://www.realvnc.com/en/" target="_blank" rel="noopener">RealVNC</a>，<a href="https://www.tightvnc.com/" target="_blank" rel="noopener">TightVNC</a>。二者都是开源的。其中TightVNC还提供远程桌面客户端(Viewer)的SDK,遗憾的是目前只提供C#的，还有一个Java的Viewer，遗憾的不是SDK，而是整个客户端Viewer。</p>
<h2 id="VNC基本组成架构"><a href="#VNC基本组成架构" class="headerlink" title="VNC基本组成架构"></a>VNC基本组成架构</h2><hr>
<p>VNC总体遵循C/S架构。所以可以归结以下几点：</p>
<ul>
<li>VNC Server， 共享被控机器的屏幕，以被动的方式受VNC Client 控制</li>
<li>VNC Client, 有时候也称为VNC Viewer,可以观看服务端控制的屏幕，远程操作服务端</li>
<li>VNC协议，准确来说是RFB协议，没有采用该协议的远程桌面就不叫VNC，该协议的目的非常简单，就是把一帧帧地把像素矩阵（坐标系统是以左上角为原点的二维x，y坐标系）和事件消息（鼠标消息，键盘消息）从服务端传送到客户端。</li>
</ul>
<h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><hr>
<p>VNC Server 运行在被控方的机器不需要物理显示器，一个默认的方式就是，客户端Viewer连接到Server端的端口上（默认5900），当然，浏览器其实也可以连接到Server端（这必须看实现，默认端口5800）。最后，Server也能以“侦听模式”连接客户端上的5500端口，这样的一个优势就是，Server端不需要配置防火墙就能允许客户端连接5900或5800端口，对于客户端来说，服务端配置的人员就可以不需要懂这些知识点，更多的是客户端的操作人员需要懂。</p>
<p>从远程屏幕帧数据流向来讲，Server端是把一帧的frame buffer分解成多个块矩阵发送给客户端，RFB协议可以使用多种带宽，所以这多种的方法，就是为了降低server端和client端的过多的通信核交成本。比如，RTB协议有多种编码类型（为了更加高效的传输这些多个矩阵块），RFB协议允许客户端和Server端在开始传输之前协商好即将使用的编码类型。最简单的编码类型所有客户端和Server端都支持，这种编码类型是将像素数据从左到友按照扫描行(scanline)顺序发送，等待整屏幕的像素数据传送完成时，之后就仅仅只发送屏幕中发生变化的像素部分了。但是这种编码类型有一个限制就是，仅仅只能在屏幕不大幅度更新像素的时候工作良好，一旦屏幕像素发生大幅度更新，所占用的带宽就会很大。（鼠标指针移动，打字就是小幅度的更新，但是看电影，滚动屏幕就是大幅度更新）</p>
<h2 id="RFB协议的限制"><a href="#RFB协议的限制" class="headerlink" title="RFB协议的限制"></a>RFB协议的限制</h2><hr>
<ul>
<li><p>远程控制的粘贴板不支持复制粘贴Unicode文本，不能传送任何除Latin-1 character set以外的字符集编码。</p>
</li>
<li><p>因为是基于像素传送的协议，所以从效率上来说，就没有那些采用了更加底层的图形系统的（Linux下的X11或windows下的RDP，RDP协议是Windows自带的远程桌面控制采用的协议）解决方案更高效。</p>
</li>
<li><p>不是为安全设计的协议，传输密码有被嗅探到的可能</p>
</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><hr>
<p>VNC Html 5客户端（Web Sockets，Canvas）：</p>
<p><a href="https://github.com/novnc/noVNC" target="_blank" rel="noopener">https://github.com/novnc/noVNC</a></p>
<p>Libvncserver/client :</p>
<p><a href="https://github.com/LibVNC/libvncserver" target="_blank" rel="noopener">https://github.com/LibVNC/libvncserver</a></p>
<p>另外，需要注意的一点就是libvncserver这个开源VNC框架，还有很多BUG，至少在windows 10上是这样的，所以几个月前向作者提了个issue，目测还是没解决，链接在这里：<a href="https://github.com/LibVNC/libvncserver/issues/165" target="_blank" rel="noopener">https://github.com/LibVNC/libvncserver/issues/165</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexiachen.github.io/blog/2017/12/01/remote-desktop/" data-id="cjtcsryeo001wr8qfvzhlfm6n" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/RFB协议/">RFB协议</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/VNC协议/">VNC协议</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/远程桌面/">远程桌面</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nginx-queue" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/11/18/nginx-queue/" class="article-date">
  <time datetime="2017-11-18T05:30:00.000Z" itemprop="datePublished">2017-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/11/18/nginx-queue/">对Nginx队列源码ngx_queue_t的一次分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><hr>
<p>前几天公司的群里讨论了<a href="https://en.wikipedia.org/wiki/Nginx" target="_blank" rel="noopener">Nginx</a>内部实现的一个数据结构，ngx_queue_t。 实质上是一个<a href="https://en.wikipedia.org/wiki/Doubly_linked_list" target="_blank" rel="noopener">双向链表</a>，但是当时讨论没有讨论出结果来，原因我自己也被绕晕了，今天本着从问题本身出发，不被别人的想法思路所左右，不看网络上任何文章的分析，好好写测试用例来证明自己的想法，其实那天的问题是围绕着两个C语言的宏展开的，那么这篇文章也会重点讲解这两个宏的意义：offsetof 和 ngx_queue_data。所以这篇文章不会涉及到链表插入,删除等细节。</p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><hr>
<p>首先，Nginx源码实现这个数据结构，用了大量的宏，我们先用我们的思路，把关键信息抽取出来:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> u_char unsigned char  </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_queue_s</span>  <span class="title">ngx_queue_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_queue_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *prev;   <span class="comment">//前一个  </span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *next;   <span class="comment">//下一个  </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以上代码就是这个链表的关键，ngx_queue_s 和 ngx_queue_t都是链表的节点类型，结构体中有链表的前驱（prev）和后驱（next），以实现正反向遍历。唉？ 等等，如果大学的时候，上过数据结构这门课的人会有点奇怪，会这样想：链表的节点应该有相关的数据啊，不然链表有什么意义？  是的，链表的节点必须有数据，但是上面这个结构体却没有，这是怎么回事？如果在当时，我想大部分人会写成以下这样:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_queue_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> data;             <span class="comment">// 数据</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *prev;   <span class="comment">//前一个  </span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *next;   <span class="comment">//下一个  </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这样每访问一个节点的时候，就可以通过节点的指针指向数据了。但是，你有没有想过，万一这个链表的数据是人名呢？不是int型，又或是其他复杂点的类型怎么办？ 是不是又要重新定一个新的链表节点类型？  这样就麻烦了不少，软件工程里面奉行了一个原则，这个原则就是<a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" target="_blank" rel="noopener">DRY原则</a>。所以为了让不同类型采用同一个数据结构实现，就需要类型与数据结构实现分离，让这个数据结构的实现适配不同的类型，当然C++中有STL已经帮你做好了，Java也是。但是C语言就不支持泛型，Nginx由于是C语言实现的，所以采用了一种叫寄宿链表的思想，这种思想就是分离数据类型与数据结构实现的。</p>
<p>看到这里，就有人会想，这种思想跟文章要分析的两个宏有什么关系呢？ 现在我可以先放结论，它们之间有莫大的关系，正因为采用了寄宿链表的思想，才会间接产生了那两个宏，这种变形掩盖了一些实质。所以其实宏不是关键，是寄宿链表的思想才是关键！我们需要知道Why，而不是How，不然会深入无限的细节当中去。</p>
<p>话说回来，下面我们来看那两个宏的实现:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 取struct_type类型的成员相对于struct_type基地址的偏移量（字节数） 一定要是POD 类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> offsetof(struct_type, member)   ((size_t) &amp;((struct_type *) 0)-&gt;member)   </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_queue_data(node_addr,struct_type,member)  (struct_type *)((u_char*)node_addr - offsetof(struct_type, member))</span></span><br></pre></td></tr></table></figure>
<p>我们发现ngx_queue_data这个宏复用了offsetof这个宏，那么首先分析offsetof这个宏:</p>
<p>这个宏根据名字可以很容易就看出来，就是字面意思，取某个结构体成员相对于结构体基址的偏移量（字节）。我们写一段代码测试来验证我们的想法:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SFamily</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> addr[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">int</span> nums;</span><br><span class="line">&#125;Family;</span><br><span class="line"></span><br><span class="line"><span class="comment">//编译时断言，所谓的静态断言, 所以offsetof这个宏在编译时就计算出了结构体成员的偏移</span></span><br><span class="line"><span class="keyword">static_assert</span>(offsetof(Family, nums) == <span class="number">260</span>,<span class="string">"nums offset is 260"</span>);</span><br><span class="line"><span class="keyword">static_assert</span>(offsetof(Family, id) == <span class="number">0</span>, <span class="string">"id offset is 0"</span>);</span><br><span class="line"><span class="keyword">static_assert</span>(offsetof(Family, addr) == <span class="number">4</span>, <span class="string">"addr offset is 4"</span>);</span><br></pre></td></tr></table></figure>
<p>根据代码结果，轻而易举的验证了我们的想法，而且这个求偏移是静态编译时就能得出的。不然以上代码直接不能通过编译。</p>
<p>好了，之后我们先别着急研究ngx_queue_data这个宏是怎么回事。先来看看怎么使用这个数据结构，怎样来用操作数据结构的一些方法，Nginx中已经定义好了，但是这些方法，是大量的宏定义的，这些宏不是关键，我把它们都改成了C/C++的函数形式：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> u_char unsigned char  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 取struct_type类型的成员相对于struct_type基地址的偏移量（字节数） 一定要是POD 类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> offsetof(struct_type, member)   ((size_t) &amp;((struct_type *) 0)-&gt;member)   </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_queue_s</span>  <span class="title">ngx_queue_t</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_queue_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *prev;   <span class="comment">//前一个  </span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span>  *next;   <span class="comment">//下一个  </span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ngx_queue_init</span><span class="params">(ngx_queue_s* q)</span></span>&#123;</span><br><span class="line">    (q)-&gt;prev = q;                                                          </span><br><span class="line">    (q)-&gt;next = q;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ngx_queue_empty</span><span class="params">(ngx_queue_s* head)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> head == head-&gt;prev;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ngx_queue_insert_head</span><span class="params">(ngx_queue_s* head, ngx_queue_s* node)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    node-&gt;next = head-&gt;next;</span><br><span class="line">    head-&gt;next-&gt;prev = node;</span><br><span class="line">    head-&gt;next = node;</span><br><span class="line">    node-&gt;prev = head;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ngx_queue_insert_after</span><span class="params">(ngx_queue_s* pos, ngx_queue_s* node)</span></span>&#123;</span><br><span class="line">    ngx_queue_insert_head(pos, node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ngx_queue_insert_tail</span><span class="params">(ngx_queue_s* tail, ngx_queue_s* node)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    node-&gt;prev = tail-&gt;prev;</span><br><span class="line">    tail-&gt;prev-&gt;next = node;</span><br><span class="line">    tail-&gt;prev = node;</span><br><span class="line">    node-&gt;next = tail;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 头节点和尾节点都是哑节点(dummy node)，并不存储实际数据</span></span><br><span class="line"><span class="function">ngx_queue_s* <span class="title">ngx_queue_head</span><span class="params">(ngx_queue_s* head)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> head-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ngx_queue_s* <span class="title">ngx_queue_last</span><span class="params">(ngx_queue_s* tail)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> tail-&gt;prev;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//直接取 head dummy node</span></span><br><span class="line"><span class="function">ngx_queue_s* <span class="title">ngx_queue_sentinel</span><span class="params">(ngx_queue_s* head)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//当前节点的下一个节点</span></span><br><span class="line"><span class="function">ngx_queue_s* <span class="title">ngx_queue_next</span><span class="params">(ngx_queue_s* cur)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> cur-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//当前节点的上一个节点</span></span><br><span class="line"><span class="function">ngx_queue_s* <span class="title">ngx_queue_prev</span><span class="params">(ngx_queue_s* cur)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> cur-&gt;prev;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除节点</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ngx_queue_remove</span><span class="params">(ngx_queue_s* node)</span></span>&#123;</span><br><span class="line">    node-&gt;prev-&gt;next = node-&gt;next;</span><br><span class="line">    node-&gt;next-&gt;prev = node-&gt;prev;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ngx_queue_data(node_addr,struct_type,member)  (struct_type *)((u_char*)node_addr - offsetof(struct_type, member))</span></span><br></pre></td></tr></table></figure>
<p>这些函数的用法官方都提供了，我们根据用法，自己实现些测试用例,我们打算实现两个链表，一个是存放书籍信息的，一个是存放人员信息的，写入数据，然后遍历打印它们，看看接口是否正确：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Book</span>&#123;</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span> link;</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">256</span>];</span><br><span class="line">&#125;Book;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Person</span>&#123;</span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">int</span> sex;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">ngx_queue_t</span> link;</span><br><span class="line">&#125;Person;</span><br><span class="line"></span><br><span class="line"> Book book1, book2, book3;</span><br><span class="line">    Person person1, person2, person3;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static_assert</span>(offsetof(Book, link) == <span class="number">0</span>, <span class="string">"link offset is 0"</span>);</span><br><span class="line">    <span class="keyword">static_assert</span>(offsetof(Person, link) == <span class="number">260</span>, <span class="string">"link offset is 260"</span>);</span><br><span class="line"></span><br><span class="line">    book1.type = <span class="number">1</span>;</span><br><span class="line">    book2.type = <span class="number">2</span>;</span><br><span class="line">    book3.type = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    person1.sex = <span class="number">1</span>;</span><br><span class="line">    person2.sex = <span class="number">0</span>;</span><br><span class="line">    person3.sex = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(book1.name, <span class="string">"Harry Potter"</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(book2.name, <span class="string">"the lord of ring"</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(book3.name, <span class="string">"Jame"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(person1.name, <span class="string">"Fan BingBing"</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(person2.name, <span class="string">"Wu YanZu"</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(person3.name, <span class="string">"ShuQi"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化队列</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span> bookQueue;</span><br><span class="line">    ngx_queue_init(&amp;bookQueue);</span><br><span class="line">    ngx_queue_insert_head(&amp;bookQueue, &amp;book1.link);</span><br><span class="line">    ngx_queue_insert_tail(&amp;bookQueue, &amp;book2.link);</span><br><span class="line">    ngx_queue_insert_tail(&amp;bookQueue, &amp;book3.link);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_queue_t</span> personQueue;</span><br><span class="line">    ngx_queue_init(&amp;personQueue);</span><br><span class="line">    ngx_queue_insert_head(&amp;personQueue, &amp;person1.link);</span><br><span class="line">    ngx_queue_insert_tail(&amp;personQueue, &amp;person2.link);</span><br><span class="line">    ngx_queue_insert_tail(&amp;personQueue, &amp;person3.link);</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> iter = ngx_queue_head(&amp;bookQueue); iter != ngx_queue_sentinel(&amp;bookQueue); iter = ngx_queue_next(iter))</span><br><span class="line">    &#123;</span><br><span class="line">        Book* bookPtr = (Book*)ngx_queue_data(iter, Book, link);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Book name is: %s . type is %d \n"</span>, bookPtr-&gt;name, bookPtr-&gt;type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> iter = ngx_queue_head(&amp;personQueue); iter != ngx_queue_sentinel(&amp;personQueue); iter = ngx_queue_next(iter))</span><br><span class="line">    &#123;</span><br><span class="line">        Person* personPtr = (Person*)ngx_queue_data(iter, Person, link);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Person name is: %s . sex is %s\n"</span>, personPtr-&gt;name, personPtr-&gt;sex == <span class="number">1</span> ? <span class="string">"Female"</span> : <span class="string">"Male"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>以上代码的打印结果如我们所想，是正确的。注意了，我们遍历访问链表单个节点的时候用了ngx_queue_data这个宏，正是我们需要了解的宏。看来跟C语言数组，C++ vector的遍历访问差不多嘛，访问一个节点元素需要的就是节点的下标（或者说地址）。</p>
<p>接下来我们再看链表节点的真正的数据是定义在哪？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Book</span>&#123;</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span> link;</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">256</span>];</span><br><span class="line">&#125;Book;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Person</span>&#123;</span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">int</span> sex;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">ngx_queue_t</span> link;</span><br><span class="line">&#125;Person;</span><br></pre></td></tr></table></figure>
<p>注意了，以上两个结构体里面都有链表节点类型ngx_queue_t，变量名link，想想，是不是数据类型与数据结构就分离了？<br>不同的数据类型复用了相同类型的数据结构？ 这样访问节点就可以通过它们的link成员来正反向迭代了，所以之前的代码iter变量实际就是link成员的地址，我们可以访问每个结构体里面的link成员变量了，那么怎么知道结构体其他数据呢？没有地址，不知道在哪啊？  其实关键就是通过link成员的地址来计算出结构体的地址的,下面举个例子:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// iter为链表节点的地址，而链表节点又在Book和Person结构体中</span></span><br><span class="line">Book* bookPtr = (Book*)ngx_queue_data(iter, Book, link);</span><br><span class="line"></span><br><span class="line">Person* personPtr = (Person*)ngx_queue_data(iter, Person, link);</span><br></pre></td></tr></table></figure>
<p>看到上面代码并且联系ngx_queue_data宏的实现，是不是就明白了？</p>
<p><strong><font color="red">链表节点成员的地址 ➖ 链表节点成员相对于结构体基址的偏移 = 结构体的基址</font></strong></p>
<p>那么是不是就可以通过结构体基址的地址强制转换为结构体的指针，访问结构体其他数据成员了？还不明白？ 那么再看下面:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Book</span>&#123;</span></span><br><span class="line">    <span class="keyword">ngx_queue_t</span> link; <span class="comment">// 这个link变量的地址知道了，是不是就可以知道Book结构体基址了？  link的地址假如为123，link的偏移为0，那么123 - 0 = 123。123为数据的结构体地址</span></span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">256</span>];</span><br><span class="line">&#125;Book;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Person</span>&#123;</span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">int</span> sex;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">ngx_queue_t</span> link;<span class="comment">// 这个link变量的地址知道了，是不是就可以知道Person结构体基址了？  link的地址假如为300，link的偏移为260，那么300 - 260 = 40。40为数据的结构体地址</span></span><br><span class="line">&#125;Person;</span><br></pre></td></tr></table></figure>
<p><strong>EOF</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://alexiachen.github.io/blog/2017/11/18/nginx-queue/" data-id="cjtcsryh2007ar8qfgwm4g5mm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/双向链表/">双向链表</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/数据结构与算法/">数据结构与算法</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/blog/">&laquo; Prev</a><a class="page-number" href="/blog/">1</a><span class="page-number current">2</span><a class="page-number" href="/blog/page/3/">3</a><a class="page-number" href="/blog/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/8/">8</a><a class="extend next" rel="next" href="/blog/page/3/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Bloom-Filter/">Bloom Filter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/C-C/">C/C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/CERT/">CERT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/CMake/">CMake</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/DLL/">DLL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/DNS/">DNS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/IM/">IM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/IO/">IO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/MySQL/">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Oracle/">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Qos/">Qos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/RFB协议/">RFB协议</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/SQLite/">SQLite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Scala/">Scala</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/TCP-IP/">TCP/IP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/VNC协议/">VNC协议</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Visual-Studio/">Visual Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Win32/">Win32</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Y组合子/">Y组合子</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/bat/">bat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ioccc/">ioccc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/lambda演算/">lambda演算</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/windows/">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/上下文无关文法/">上下文无关文法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/事业/">事业</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/互联网/">互联网</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/人生/">人生</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/传统行业/">传统行业</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/信息安全/">信息安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/内存模型/">内存模型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/函数式编程/">函数式编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/单例模式/">单例模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/双向链表/">双向链表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/可计算性/">可计算性</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/同步异步/">同步异步</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/团队管理/">团队管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/多核编程/">多核编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/多线程编程/">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/天体物理/">天体物理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/套路/">套路</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/学术/">学术</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/宇宙学/">宇宙学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/性能优化/">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/技术/">技术</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/指令重排序/">指令重排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/操作系统/">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/敏捷开发/">敏捷开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/数据压缩/">数据压缩</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/数据恢复/">数据恢复</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/数据结构与算法/">数据结构与算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/旅行/">旅行</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/无线网卡/">无线网卡</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/有限自动机/">有限自动机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/构建工具/">构建工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/模板元编程/">模板元编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/民主/">民主</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/汇编语言/">汇编语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/消息推送/">消息推送</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/混乱代码/">混乱代码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/物联网/">物联网</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/猎人/">猎人</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/理想/">理想</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/理论计算机/">理论计算机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/生活/">生活</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/研究/">研究</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/程序语言理论/">程序语言理论</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/类型系统/">类型系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/线程/">线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/线程安全/">线程安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/缓存/">缓存</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/编程范式/">编程范式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/编程语言/">编程语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/编译原理/">编译原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/美国/">美国</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/职业生涯/">职业生涯</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/自然语言处理/">自然语言处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/自由/">自由</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/英语/">英语</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/装修/">装修</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/计算机体系结构/">计算机体系结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/计算机科学/">计算机科学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/计算机网络/">计算机网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/计算理论/">计算理论</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/词法分析/">词法分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/诗歌/">诗歌</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/语义学/">语义学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/调试/">调试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/软件工程/">软件工程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/软件开发/">软件开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/软件调试/">软件调试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/远程桌面/">远程桌面</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/逻辑/">逻辑</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/重构/">重构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/错误处理/">错误处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/闭包/">闭包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/阻塞非阻塞/">阻塞非阻塞</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/项目管理/">项目管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/马尔科夫链/">马尔科夫链</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/驱动开发/">驱动开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/黑洞/">黑洞</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/Bloom-Filter/" style="font-size: 10px;">Bloom Filter</a> <a href="/blog/tags/C-C/" style="font-size: 20px;">C/C++</a> <a href="/blog/tags/CERT/" style="font-size: 18.33px;">CERT</a> <a href="/blog/tags/CMake/" style="font-size: 10px;">CMake</a> <a href="/blog/tags/DLL/" style="font-size: 10px;">DLL</a> <a href="/blog/tags/DNS/" style="font-size: 10px;">DNS</a> <a href="/blog/tags/IM/" style="font-size: 13.33px;">IM</a> <a href="/blog/tags/IO/" style="font-size: 10px;">IO</a> <a href="/blog/tags/Java/" style="font-size: 10px;">Java</a> <a href="/blog/tags/Linux/" style="font-size: 13.33px;">Linux</a> <a href="/blog/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/blog/tags/Oracle/" style="font-size: 10px;">Oracle</a> <a href="/blog/tags/Qos/" style="font-size: 11.67px;">Qos</a> <a href="/blog/tags/RFB协议/" style="font-size: 10px;">RFB协议</a> <a href="/blog/tags/SQLite/" style="font-size: 10px;">SQLite</a> <a href="/blog/tags/Scala/" style="font-size: 10px;">Scala</a> <a href="/blog/tags/TCP-IP/" style="font-size: 10px;">TCP/IP</a> <a href="/blog/tags/VNC协议/" style="font-size: 10px;">VNC协议</a> <a href="/blog/tags/Visual-Studio/" style="font-size: 10px;">Visual Studio</a> <a href="/blog/tags/Win32/" style="font-size: 13.33px;">Win32</a> <a href="/blog/tags/Y组合子/" style="font-size: 10px;">Y组合子</a> <a href="/blog/tags/bat/" style="font-size: 10px;">bat</a> <a href="/blog/tags/ioccc/" style="font-size: 10px;">ioccc</a> <a href="/blog/tags/lambda演算/" style="font-size: 10px;">lambda演算</a> <a href="/blog/tags/windows/" style="font-size: 11.67px;">windows</a> <a href="/blog/tags/上下文无关文法/" style="font-size: 10px;">上下文无关文法</a> <a href="/blog/tags/事业/" style="font-size: 10px;">事业</a> <a href="/blog/tags/互联网/" style="font-size: 10px;">互联网</a> <a href="/blog/tags/人生/" style="font-size: 10px;">人生</a> <a href="/blog/tags/传统行业/" style="font-size: 10px;">传统行业</a> <a href="/blog/tags/信息安全/" style="font-size: 10px;">信息安全</a> <a href="/blog/tags/内存模型/" style="font-size: 10px;">内存模型</a> <a href="/blog/tags/函数式编程/" style="font-size: 11.67px;">函数式编程</a> <a href="/blog/tags/单例模式/" style="font-size: 10px;">单例模式</a> <a href="/blog/tags/双向链表/" style="font-size: 10px;">双向链表</a> <a href="/blog/tags/可计算性/" style="font-size: 10px;">可计算性</a> <a href="/blog/tags/同步异步/" style="font-size: 10px;">同步异步</a> <a href="/blog/tags/团队管理/" style="font-size: 11.67px;">团队管理</a> <a href="/blog/tags/多核编程/" style="font-size: 10px;">多核编程</a> <a href="/blog/tags/多线程编程/" style="font-size: 10px;">多线程编程</a> <a href="/blog/tags/天体物理/" style="font-size: 10px;">天体物理</a> <a href="/blog/tags/套路/" style="font-size: 10px;">套路</a> <a href="/blog/tags/学术/" style="font-size: 10px;">学术</a> <a href="/blog/tags/宇宙学/" style="font-size: 10px;">宇宙学</a> <a href="/blog/tags/性能优化/" style="font-size: 10px;">性能优化</a> <a href="/blog/tags/技术/" style="font-size: 10px;">技术</a> <a href="/blog/tags/指令重排序/" style="font-size: 10px;">指令重排序</a> <a href="/blog/tags/操作系统/" style="font-size: 10px;">操作系统</a> <a href="/blog/tags/敏捷开发/" style="font-size: 10px;">敏捷开发</a> <a href="/blog/tags/数据压缩/" style="font-size: 10px;">数据压缩</a> <a href="/blog/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/blog/tags/数据恢复/" style="font-size: 10px;">数据恢复</a> <a href="/blog/tags/数据结构与算法/" style="font-size: 11.67px;">数据结构与算法</a> <a href="/blog/tags/旅行/" style="font-size: 10px;">旅行</a> <a href="/blog/tags/无线网卡/" style="font-size: 10px;">无线网卡</a> <a href="/blog/tags/有限自动机/" style="font-size: 10px;">有限自动机</a> <a href="/blog/tags/构建工具/" style="font-size: 10px;">构建工具</a> <a href="/blog/tags/模板元编程/" style="font-size: 10px;">模板元编程</a> <a href="/blog/tags/民主/" style="font-size: 11.67px;">民主</a> <a href="/blog/tags/汇编语言/" style="font-size: 10px;">汇编语言</a> <a href="/blog/tags/消息推送/" style="font-size: 10px;">消息推送</a> <a href="/blog/tags/混乱代码/" style="font-size: 10px;">混乱代码</a> <a href="/blog/tags/物联网/" style="font-size: 10px;">物联网</a> <a href="/blog/tags/猎人/" style="font-size: 10px;">猎人</a> <a href="/blog/tags/理想/" style="font-size: 10px;">理想</a> <a href="/blog/tags/理论计算机/" style="font-size: 10px;">理论计算机</a> <a href="/blog/tags/生活/" style="font-size: 13.33px;">生活</a> <a href="/blog/tags/研究/" style="font-size: 10px;">研究</a> <a href="/blog/tags/程序语言理论/" style="font-size: 15px;">程序语言理论</a> <a href="/blog/tags/类型系统/" style="font-size: 10px;">类型系统</a> <a href="/blog/tags/线程/" style="font-size: 10px;">线程</a> <a href="/blog/tags/线程安全/" style="font-size: 10px;">线程安全</a> <a href="/blog/tags/缓存/" style="font-size: 10px;">缓存</a> <a href="/blog/tags/编程范式/" style="font-size: 10px;">编程范式</a> <a href="/blog/tags/编程语言/" style="font-size: 10px;">编程语言</a> <a href="/blog/tags/编译原理/" style="font-size: 11.67px;">编译原理</a> <a href="/blog/tags/美国/" style="font-size: 10px;">美国</a> <a href="/blog/tags/职业生涯/" style="font-size: 10px;">职业生涯</a> <a href="/blog/tags/自然语言处理/" style="font-size: 10px;">自然语言处理</a> <a href="/blog/tags/自由/" style="font-size: 11.67px;">自由</a> <a href="/blog/tags/英语/" style="font-size: 10px;">英语</a> <a href="/blog/tags/装修/" style="font-size: 10px;">装修</a> <a href="/blog/tags/计算机体系结构/" style="font-size: 10px;">计算机体系结构</a> <a href="/blog/tags/计算机科学/" style="font-size: 10px;">计算机科学</a> <a href="/blog/tags/计算机网络/" style="font-size: 11.67px;">计算机网络</a> <a href="/blog/tags/计算理论/" style="font-size: 11.67px;">计算理论</a> <a href="/blog/tags/词法分析/" style="font-size: 10px;">词法分析</a> <a href="/blog/tags/诗歌/" style="font-size: 10px;">诗歌</a> <a href="/blog/tags/语义学/" style="font-size: 10px;">语义学</a> <a href="/blog/tags/调试/" style="font-size: 11.67px;">调试</a> <a href="/blog/tags/软件工程/" style="font-size: 16.67px;">软件工程</a> <a href="/blog/tags/软件开发/" style="font-size: 10px;">软件开发</a> <a href="/blog/tags/软件调试/" style="font-size: 10px;">软件调试</a> <a href="/blog/tags/远程桌面/" style="font-size: 10px;">远程桌面</a> <a href="/blog/tags/逻辑/" style="font-size: 11.67px;">逻辑</a> <a href="/blog/tags/重构/" style="font-size: 10px;">重构</a> <a href="/blog/tags/错误处理/" style="font-size: 10px;">错误处理</a> <a href="/blog/tags/闭包/" style="font-size: 10px;">闭包</a> <a href="/blog/tags/阻塞非阻塞/" style="font-size: 10px;">阻塞非阻塞</a> <a href="/blog/tags/项目管理/" style="font-size: 11.67px;">项目管理</a> <a href="/blog/tags/马尔科夫链/" style="font-size: 10px;">马尔科夫链</a> <a href="/blog/tags/驱动开发/" style="font-size: 10px;">驱动开发</a> <a href="/blog/tags/黑洞/" style="font-size: 10px;">黑洞</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/11/">November 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/09/">September 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/08/">August 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/06/">June 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/05/">May 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/03/">March 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2013/07/">July 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2013/06/">June 2013</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2019/03/17/bloom-filter/">实现一个简单的高性能布隆过滤器</a>
          </li>
        
          <li>
            <a href="/blog/2019/03/10/auto-complete-markov-chain/">用马尔科夫链来做自动补全</a>
          </li>
        
          <li>
            <a href="/blog/2018/12/15/manjaro-rtl8821ce/">manjaro下安装配置无线网卡驱动</a>
          </li>
        
          <li>
            <a href="/blog/2018/11/11/cpp-closure/">C++的闭包</a>
          </li>
        
          <li>
            <a href="/blog/2018/10/15/finite-automaton/">最简单的计算机之有限自动机</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 MathxH Chen<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/blog/about" class="mobile-nav-link">About</a>
  
    <a href="/blog/resume" class="mobile-nav-link">Resume</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>



  </div>
</body>
</html>